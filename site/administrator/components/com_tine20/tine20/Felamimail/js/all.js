/*
 * Tine 2.0 USER CLIENT
 * 
 * license     http://www.gnu.org/licenses/agpl.html AGPL Version 3
 * copyright   Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 *
 * FOR MORE DETAILED LICENSE AND COPYRIGHT INFORMATION PLEASE CONSULT THE LICENSE FILE 
 * LOCATED AT: <YOUR TINE 2.0 URL>/LICENSE OR VISIT THE TINE 2.0 HOMEPAGE AT http://www.tine20.org
 */
Ext.ns("Tine.Felamimail.Model");Tine.Felamimail.Model.Message=Tine.Tinebase.data.Record.create([{name:"id"},{name:"account_id"},{name:"subject"},{name:"from_email"},{name:"from_name"},{name:"sender"},{name:"to"},{name:"cc"},{name:"bcc"},{name:"sent",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"received",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"flags"},{name:"size"},{name:"body",defaultValue:undefined},{name:"headers"},{name:"content_type"},{name:"body_content_type"},{name:"structure"},{name:"attachments"},{name:"original_id"},{name:"folder_id"},{name:"note"}],{appName:"Felamimail",modelName:"Message",idProperty:"id",titleProperty:"subject",recordName:"Message",recordsName:"Messages",containerProperty:"folder_id",containerName:"Folder",containersName:"Folders",hasFlag:function(b){var a=this.get("flags")||[];return a.indexOf(b)>=0},addFlag:function(b){if(!this.hasFlag(b)){var a=Ext.unique(this.get("flags"));a.push(b);this.set("flags",a);return true}return false},bodyIsFetched:function(){return this.get("body")!==undefined},clearFlag:function(b){if(this.hasFlag(b)){var a=Ext.unique(this.get("flags"));a.remove(b);this.set("flags",a);return true}return false}});Tine.Felamimail.Model.Message.getDefaultData=function(){var a=Tine.Felamimail.registry.get("preferences").get("autoAttachNote");return{note:a,content_type:"text/html"}};Tine.Felamimail.Model.Message.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Felamimail");return[{filtertype:"tine.felamimail.folder.filtermodel",app:a},{label:a.i18n._("Subject/From"),field:"query",operators:["contains"]},{label:a.i18n._("Subject"),field:"subject",operators:["contains"]},{label:a.i18n._("From (Email)"),field:"from_email",operators:["contains"]},{label:a.i18n._("From (Name)"),field:"from_name",operators:["contains"]},{label:a.i18n._("To"),field:"to",operators:["contains"]},{label:a.i18n._("Cc"),field:"cc",operators:["contains"]},{label:a.i18n._("Bcc"),field:"bcc",operators:["contains"]},{label:a.i18n._("Flags"),field:"flags",filtertype:"tinebase.multiselect",app:a,multiselectFieldConfig:{valueStore:Tine.Felamimail.loadFlagsStore()}},{label:a.i18n._("Received"),field:"received",valueType:"date",pastOnly:true}]};Tine.Felamimail.messageBackend=new Tine.Tinebase.data.RecordProxy({appName:"Felamimail",modelName:"Message",recordClass:Tine.Felamimail.Model.Message,moveMessages:function(b,c,a){a=a||{};a.params=a.params||{};var d=a.params;d.method=this.appName+".moveMessages";d.filterData=b;d.targetFolderId=c;a.beforeSuccess=function(e){return[Tine.Felamimail.folderBackend.recordReader(e)]};return this.doXHTTPRequest(a)},fetchBody:function(a,b){return this.loadRecord(a,{timeout:120000,scope:this,callback:function(d,f,c){var e=this.recordReader(c);Ext.copyTo(a.data,e.data,Tine.Felamimail.Model.Message.getFieldNames().remove("flags"));if(Ext.isFunction(b)){b(a)}else{Ext.callback(b[f?"success":"failure"],b.scope,[a]);Ext.callback(b.callback,b.scope,[a])}}})},saveInFolder:function(a,d,b){b=b||{};b.params=b.params||{};b.beforeSuccess=function(e){return[this.recordReader(e)]};var c=b.params;c.method=this.appName+".saveMessageInFolder";c.recordData=a.data;c.folderName=d;b.timeout=300000;return this.doXHTTPRequest(b)},addFlags:function(c,a,b){b=b||{};b.params=b.params||{};var d=b.params;d.method=this.appName+".addFlags";d.filterData=c;d.flags=a;b.timeout=300000;return this.doXHTTPRequest(b)},clearFlags:function(c,a,b){b=b||{};b.params=b.params||{};var d=b.params;d.method=this.appName+".clearFlags";d.filterData=c;d.flags=a;b.timeout=300000;return this.doXHTTPRequest(b)},handleRequestException:function(a){Tine.Felamimail.handleRequestException(a)}});Tine.Felamimail.Model.Account=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"user_id"},{name:"name"},{name:"type"},{name:"user"},{name:"host"},{name:"email"},{name:"password"},{name:"from"},{name:"organization"},{name:"port"},{name:"ssl"},{name:"imap_status",defaultValue:"success"},{name:"sent_folder"},{name:"trash_folder"},{name:"drafts_folder"},{name:"templates_folder"},{name:"has_children_support",type:"bool"},{name:"delimiter"},{name:"display_format"},{name:"ns_personal"},{name:"ns_other"},{name:"ns_shared"},{name:"signature"},{name:"smtp_port"},{name:"smtp_hostname"},{name:"smtp_auth"},{name:"smtp_ssl"},{name:"smtp_user"},{name:"smtp_password"},{name:"sieve_hostname"},{name:"sieve_port"},{name:"sieve_ssl"},{name:"sieve_vacation_active",type:"bool"},{name:"all_folders_fetched",type:"bool",defaultValue:false}]),{appName:"Felamimail",modelName:"Account",idProperty:"id",titleProperty:"name",recordName:"Account",recordsName:"Accounts",containerProperty:"container_id",containerName:"Email Accounts",containersName:"Email Accounts",lastIMAPException:null,getLastIMAPException:function(){return this.lastIMAPException},getSendFolderId:function(){var c=Ext.ux.PopupWindowMgr.getMainWindow().Tine.Tinebase.appMgr.get("Felamimail"),b=this.get("sent_folder"),d=this.id,a=b?c.getFolderStore().queryBy(function(e){return e.get("account_id")===d&&e.get("globalname")===b},this).first():null;return a?a.id:null},getTrashFolderId:function(){var c=Ext.ux.PopupWindowMgr.getMainWindow().Tine.Tinebase.appMgr.get("Felamimail"),b=this.get("trash_folder"),d=this.id,a=b?c.getFolderStore().queryBy(function(e){return e.get("account_id")===d&&e.get("globalname")===b},this).first():null;return a?a.id:null},setLastIMAPException:function(a){this.lastIMAPException=a;this.set("imap_status",a?"failure":"success");this.commit()}});Tine.Felamimail.Model.Account.getDefaultData=function(){var b=(Tine.Felamimail.registry.get("defaults"))?Tine.Felamimail.registry.get("defaults"):{};var a=Tine.Tinebase.registry.get("currentAccount").accountDisplayName;return{from:a,host:(b.host)?b.host:"",port:(b.port)?b.port:143,smtp_hostname:(b.smtp&&b.smtp.hostname)?b.smtp.hostname:"",smtp_port:(b.smtp&&b.smtp.port)?b.smtp.port:25,smtp_ssl:(b.smtp&&b.smtp.ssl)?b.smtp.ssl:"none",sieve_port:2000,sieve_ssl:"none",signature:'Sent with love from the new tine 2.0 email client ...<br/>Please visit <a href="http://tine20.org">http://tine20.org</a>',sent_folder:(b.sent_folder)?b.sent_folder:"Sent",trash_folder:(b.trash_folder)?b.trash_folder:"Trash"}};Tine.Felamimail.accountBackend=new Tine.Tinebase.data.RecordProxy({appName:"Felamimail",modelName:"Account",recordClass:Tine.Felamimail.Model.Account,checkAccounts:function(b,a){a=a||{};a.params=a.params||{};var c=a.params;c.method=this.appName+".checkAccounts";c.ids=b;return this.doXHTTPRequest(a)}});Tine.Felamimail.Model.Folder=Tine.Tinebase.data.Record.create([{name:"id"},{name:"localname"},{name:"globalname"},{name:"path"},{name:"parent"},{name:"parent_path"},{name:"account_id"},{name:"has_children",type:"bool"},{name:"is_selectable",type:"bool"},{name:"system_folder",type:"bool"},{name:"imap_status"},{name:"imap_timestamp",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"imap_uidnext",type:"int"},{name:"imap_uidvalidity",type:"int"},{name:"imap_totalcount",type:"int"},{name:"cache_status"},{name:"cache_uidnext",type:"int"},{name:"cache_recentcount",type:"int"},{name:"cache_totalcount",type:"int"},{name:"cache_unreadcount",type:"int"},{name:"cache_timestamp",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"cache_job_actions_estimate",type:"int"},{name:"cache_job_actions_done",type:"int"},{name:"client_access_time",type:"date",dateFormat:Date.patterns.ISO8601Long}],{appName:"Felamimail",modelName:"Folder",idProperty:"id",titleProperty:"localname",recordName:"Folder",recordsName:"Folders",containerName:"Folder list",containersName:"Folder lists",isCurrentSelection:function(){if(Tine.Tinebase.appMgr.get(this.appName).getMainScreen().getTreePanel()){var a=Tine.Tinebase.appMgr.get(this.appName).getMainScreen().getTreePanel().getSelectionModel().getSelectedNode();if(a&&a.attributes.folder_id){return a.id==this.id}}return false},isInbox:function(){return Ext.util.Format.lowercase(this.get("localname"))==="inbox"},needsUpdate:function(b){var a=this.get("client_access_time");return this.get("cache_status")!=="complete"||!Ext.isDate(a)||a.getElapsed()>b}});Tine.Felamimail.folderBackend=new Tine.Tinebase.data.RecordProxy({appName:"Felamimail",modelName:"Folder",recordClass:Tine.Felamimail.Model.Folder,updateMessageCache:function(a,d,b){b=b||{};b.params=b.params||{};var c=b.params;c.method=this.appName+".updateMessageCache";c.folderId=a;c.time=d;b.beforeSuccess=function(e){var f=this.recordReader(e);f.set("client_access_time",new Date());return[f]};b.timeout=d*5000;return this.doXHTTPRequest(b)},handleRequestException:function(a){Tine.Felamimail.handleRequestException(a)}});Tine.Felamimail.Model.Vacation=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"reason"},{name:"enabled",type:"boolean"},{name:"days"},{name:"mime"}]),{appName:"Felamimail",modelName:"Vacation",idProperty:"id",titleProperty:"id",recordName:"Vacation",recordsName:"Vacations",containerName:"Vacation list",containersName:"Vacation lists"});Tine.Felamimail.Model.Vacation.getDefaultData=function(){return{days:7,mime:"multipart/alternative"}};Tine.Felamimail.vacationBackend=new Tine.Tinebase.data.RecordProxy({appName:"Felamimail",modelName:"Vacation",recordClass:Tine.Felamimail.Model.Vacation,handleRequestException:function(a){Tine.Felamimail.handleRequestException(a)}});Tine.Felamimail.Model.Rule=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id",sortType:function(a){return parseInt(a,10)}},{name:"action_type"},{name:"action_argument"},{name:"enabled",type:"boolean"},{name:"conditions"},{name:"account_id"}]),{appName:"Felamimail",modelName:"Rule",idProperty:"id",titleProperty:"id",recordName:"Rule",recordsName:"Rules",containerName:"Rule list",containersName:"Rule lists"});Tine.Felamimail.Model.Rule.getDefaultData=function(){return{enabled:true,conditions:[{test:"address",header:"from",comperator:"contains",key:""}],action_type:"fileinto",action_argument:""}};Tine.Felamimail.rulesBackend=new Tine.Tinebase.data.RecordProxy({appName:"Felamimail",modelName:"Rule",recordClass:Tine.Felamimail.Model.Rule,searchRecords:function(c,a,b){b=b||{};b.params=b.params||{};var d=b.params;d.method=this.appName+".get"+this.modelName+"s";d.accountId=c;b.beforeSuccess=function(e){return[this.jsonReader.read(e)]};b.timeout=60000;return this.doXHTTPRequest(b)},saveRules:function(d,c,a){a=a||{};a.params=a.params||{};var b=a.params;b.method=this.appName+".saveRules";b.accountId=d;b.rulesData=c;return this.doXHTTPRequest(a)},saveRecord:function(a,c,b){},handleRequestException:function(a){Tine.Felamimail.handleRequestException(a)}});Tine.Felamimail.Model.Flag=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"name"}]),{appName:"Felamimail",modelName:"Flag",idProperty:"id",titleProperty:"id",recordName:"Flag",recordsName:"Flags",containerName:"Flag list",containersName:"Flag lists"});Ext.namespace("Tine.Felamimail");Tine.Felamimail.FolderStore=function(a){a=a||{};Ext.apply(this,a);this.reader=Tine.Felamimail.folderBackend.getReader();this.queriesPending=[];this.queriesDone=[];Tine.Felamimail.FolderStore.superclass.constructor.call(this);this.on("load",this.onStoreLoad,this);this.on("add",this.onStoreAdd,this)};Ext.extend(Tine.Felamimail.FolderStore,Ext.data.Store,{fields:Tine.Felamimail.Model.Folder,proxy:Tine.Felamimail.folderBackend,queriesDone:null,queriesPending:null,asyncQuery:function(g,h,l,f,m,j){var n=null,k=j.getKey(g,h);Tine.log.info("Tine.Felamimail.FolderStore.asyncQuery: "+k);if(j.queriesDone.indexOf(k)>=0){Tine.log.debug("result already loaded -> directly query store");var d=new RegExp(h+"$");n=j.query(g,d);f.push(n);l.apply(m,f)}else{if(j.queriesPending.indexOf(k)>=0){Tine.log.debug("result not in store yet, but async query already running -> wait a bit");this.asyncQuery.defer(2500,this,[g,h,l,f,m,j])}else{Tine.log.debug("result is requested the first time -> fetch from server");var e=h.match(/^\/([a-z0-9]*)/i)[1],a=h.match(/[a-z0-9]+\/([a-z0-9]*)$/i),c=(a)?a[1]:null,b=c?j.getById(c):null;if(c&&!b){Tine.log.warn("folder "+c+" not found -> performing no query at all");l.apply(m,f);return}j.queriesPending.push(k);j.load({path:h,params:{filter:[{field:"account_id",operator:"equals",value:e},{field:"globalname",operator:"equals",value:(b!==null)?b.get("globalname"):""}]},callback:function(){j.queriesDone.push(k);j.queriesPending.remove(k);n=j.query(g,h);f.push(n);l.apply(m,f)},add:true})}}},isLoadedOrLoading:function(d,c){var b=this.getKey(d,c),a=false;a=(this.queriesDone.indexOf(b)>=0||this.queriesPending.indexOf(b)>=0);return a},getKey:function(b,a){return b+" -> "+a},onStoreLoad:function(b,a,c){this.computePaths(a,c.path)},onStoreAdd:function(b,a,c){this.computePaths(a,null)},computePaths:function(c,a){var b,d;Ext.each(c,function(e){if(a===null){var f=this.getParentByAccountIdAndGlobalname(e.get("account_id"),e.get("parent"));b=(f)?f.get("path"):"/"+e.get("account_id")}else{b=a}d=b+"/"+e.id;if(e.get("parent_path")!=b||e.get("path")!=d){e.beginEdit();e.set("parent_path",b);e.set("path",d);e.endEdit()}},this)},resetQueryAndRemoveRecords:function(c,b){this.queriesPending.remove(this.getKey(c,b));var a=this.query(c,b);a.each(function(d){this.remove(d);this.queriesDone.remove(this.getKey(c,d.get(c)))},this)},updateFolder:function(b){if(Ext.isArray(b)){Ext.each(b,function(c){this.updateFolder.call(this,c)},this);return}var a=this.getById(b.id);if(a){a.beginEdit();Ext.each(Tine.Felamimail.Model.Folder.getFieldNames(),function(c){if(!c.match("path")){a.set(c,b.get(c))}},this);a.endEdit();a.commit();return a}},getParentByAccountIdAndGlobalname:function(c,b){var a=this.queryBy(function(d,e){if(d.get("account_id")==c&&d.get("globalname")==b){return true}});return a.first()||null}});Ext.ns("Tine.Felamimail");Tine.Felamimail.FolderSelectTriggerField=Ext.extend(Ext.form.TriggerField,{triggerClass:"x-form-search-trigger",account:null,allAccounts:false,onTriggerClick:function(a){if((this.account&&this.account.id!==0)||this.allAccounts){this.selectPanel=Tine.Felamimail.FolderSelectPanel.openWindow({account:this.account,allAccounts:this.allAccounts,listeners:{scope:this,folderselect:this.onSelectFolder}})}},onSelectFolder:function(a){this.selectPanel.close();this.setValue(a.attributes.globalname);this.el.focus()}});Ext.reg("felamimailfolderselect",Tine.Felamimail.FolderSelectTriggerField);Ext.namespace("Tine.Felamimail");Tine.Felamimail.FolderSelectPanel=Ext.extend(Ext.Panel,{frame:true,border:true,autoScroll:true,bodyStyle:"background-color:white",selectedNode:null,initComponent:function(){this.addEvents("folderselect");this.app=Tine.Tinebase.appMgr.get("Felamimail");if(!this.allAccounts){this.account=this.account||this.app.getActiveAccount()}this.initActions();this.initFolderTree();Tine.Felamimail.FolderSelectPanel.superclass.initComponent.call(this)},initActions:function(){this.action_cancel=new Ext.Action({text:_("Cancel"),minWidth:70,scope:this,handler:this.onCancel,iconCls:"action_cancel"});this.action_ok=new Ext.Action({disabled:true,text:_("Ok"),iconCls:"action_saveAndClose",minWidth:70,handler:this.onOk,scope:this});this.fbar=["->",this.action_cancel,this.action_ok]},initFolderTree:function(){if(this.allAccounts){this.root=new Ext.tree.TreeNode({text:"default",draggable:false,allowDrop:false,expanded:true,leaf:false,id:"root"});Tine.Felamimail.loadAccountStore().each(function(a){var b=new Ext.tree.AsyncTreeNode({id:a.data.id,path:"/"+a.data.id,record:a,globalname:"",draggable:false,allowDrop:false,expanded:false,text:a.get("name"),qtip:a.get("host"),leaf:false,cls:"felamimail-node-account",delimiter:a.get("delimiter"),ns_personal:a.get("ns_personal"),account_id:a.data.id});this.root.appendChild(b)},this)}else{this.root=new Ext.tree.AsyncTreeNode({text:this.account.get("name"),draggable:false,allowDrop:false,expanded:true,leaf:false,cls:"felamimail-node-account",id:this.account.id,path:"/"+this.account.id})}this.folderTree=new Ext.tree.TreePanel({id:"felamimail-foldertree",rootVisible:!this.allAccounts,store:this.store||this.app.getFolderStore(),loader:this.loader||new Tine.Felamimail.TreeLoader({folderStore:this.store,app:this.app}),root:this.root});this.folderTree.on("dblclick",this.onTreeNodeDblClick,this);this.folderTree.on("click",this.onTreeNodeClick,this);this.items=[this.folderTree]},afterRender:function(){Tine.Felamimail.FolderSelectPanel.superclass.afterRender.call(this);var a=(!this.allAccounts)?String.format(this.app.i18n._("Folders of account {0}"),this.account.get("name")):this.app.i18n._("Folders of all accounts");this.window.setTitle(a)},onTreeNodeDblClick:function(a){this.selectedNode=a;this.onOk();return false},onTreeNodeClick:function(a){this.selectedNode=a;this.action_ok.setDisabled(false)},onCancel:function(){this.purgeListeners();this.window.close()},onOk:function(){if(this.selectedNode){this.fireEvent("folderselect",this.selectedNode)}}});Tine.Felamimail.FolderSelectPanel.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:200,height:300,modal:true,name:Tine.Felamimail.FolderSelectPanel.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Felamimail.FolderSelectPanel",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Felamimail.sieve");Tine.Felamimail.sieve.VacationEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{account:null,windowNamePrefix:"VacationEditWindow_",appName:"Felamimail",recordClass:Tine.Felamimail.Model.Vacation,recordProxy:Tine.Felamimail.vacationBackend,loadRecord:true,tbarItems:[],evalGrants:false,updateToolbars:function(){},onRecordLoad:function(){if(!this.rendered){this.onRecordLoad.defer(250,this);return}this.record.set("mime","multipart/alternative");this.getForm().loadRecord(this.record);var a=String.format(this.app.i18n._("Vacation Message for {0}"),this.account.get("name"));this.window.setTitle(a);this.loadMask.hide()},getFormItems:function(){this.reasonEditor=new Ext.form.HtmlEditor({fieldLabel:this.app.i18n._("Incoming mails will be answered with this text:"),name:"reason",allowBlank:true,disabled:(this.record.get("enabled")==false),height:220,getDocMarkup:function(){var a="<html><body></body></html>";return a},plugins:[new Ext.ux.form.HtmlEditor.RemoveFormat()]});return{xtype:"tabpanel",deferredRender:false,border:false,activeTab:0,items:[{title:this.app.i18n._("General"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{anchor:"100%",labelSeparator:"",columnWidth:1},items:[[{fieldLabel:this.app.i18n._("Status"),name:"enabled",typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",forceSelection:true,value:0,xtype:"combo",store:[[0,this.app.i18n._("I am available (vacation message disabled)")],[1,this.app.i18n._("I am not available (vacation message enabled)")]],listeners:{scope:this,select:function(b,a){this.reasonEditor.setDisabled(!a.data.field1)}}},this.reasonEditor]]},{title:this.app.i18n._("Advanced"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{anchor:"100%",labelSeparator:"",columnWidth:1},items:[[{fieldLabel:this.app.i18n._("Only send all X days to the same sender"),name:"days",value:7,xtype:"numberfield",allowNegative:false,minValue:1}]]}]}},onRequestFailed:function(a){Tine.Felamimail.handleRequestException(a);this.loadMask.hide()}});Tine.Felamimail.sieve.VacationEditDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:640,height:480,name:Tine.Felamimail.sieve.VacationEditDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Felamimail.sieve.VacationEditDialog",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Felamimail.sieve");Tine.Felamimail.sieve.RuleEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{account:null,windowNamePrefix:"RuleEditWindow_",appName:"Felamimail",recordClass:Tine.Felamimail.Model.Rule,mode:"local",loadRecord:true,tbarItems:[],evalGrants:false,updateToolbars:function(){},onRender:function(b,a){Tine.Felamimail.sieve.RuleEditDialog.superclass.onRender.call(this,b,a);this.onChangeType.defer(250,this)},onChangeType:function(){var a=this.actionTypeCombo.getValue();var b=Ext.getCmp(this.idPrefix+"CardLayout").getLayout();if(b!=="card"){b.setActiveItem(this.idPrefix+a);if(this.record.get("action_type")==a){var c=this.getForm().findField("action_argument_"+a);if(c!==null){c.setValue(this.record.get("action_argument"))}}}},onRecordLoad:function(){if(!this.rendered){this.onRecordLoad.defer(250,this);return}var a=this.app.i18n._("Edit Filter Rule");this.window.setTitle(a);this.getForm().loadRecord(this.record);this.loadMask.hide()},onRecordUpdate:function(){Tine.Felamimail.sieve.RuleEditDialog.superclass.onRecordUpdate.call(this);this.record.set("conditions",this.getConditions());var b=this.getForm().findField("action_argument_"+this.actionTypeCombo.getValue()),a=(b!==null)?b.getValue():"";this.record.set("action_argument",a)},getConditions:function(){var d=this.conditionsPanel.getAllFilterData();var a=[],b=0,g,f,c,e;for(b=0;b<d.length;b++){c=d[b].operator;e=d[b].field;f="header";switch(d[b].field){case"from":case"to":f="address";break;case"size":f="size";c=(d[b].operator=="greater")?"over":"under";break;case"header":e=d[b].operator;c="contains";break}g={test:f,header:e,comperator:c,key:d[b].value};a.push(g)}return a},getConditionsFilter:function(){var f=this.record.get("conditions");var a=[],c=0,d,b,e;for(c=0;c<f.length;c++){e=f[c].header;switch(e){case"size":b=(f[c].comperator=="over")?"greater":"less";break;case"from":case"to":case"subject":b=f[c].comperator;break;default:b=e;e="header"}d={field:e,operator:b,value:f[c].key};a.push(d)}return a},getFormItems:function(){this.conditionsPanel=new Tine.Felamimail.sieve.RuleConditionsPanel({filters:this.getConditionsFilter()});this.actionTypeCombo=new Ext.form.ComboBox({hideLabel:true,name:"action_type",typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",forceSelection:true,value:"discard",columnWidth:0.4,store:Tine.Felamimail.sieve.RuleEditDialog.getActionTypes(this.app),listeners:{scope:this,change:this.onChangeType,select:this.onChangeType}});this.idPrefix=Ext.id();return[{xtype:"panel",layout:"border",autoScroll:true,items:[{title:this.app.i18n._("If all of the following conditions are met:"),region:"north",border:false,items:[this.conditionsPanel],xtype:"panel",listeners:{scope:this,afterlayout:function(a,b){a.suspendEvents();a.setHeight(this.conditionsPanel.getHeight()+30);a.ownerCt.layout.layout();a.resumeEvents()}}},{title:this.app.i18n._("Do this action:"),region:"center",border:false,frame:true,layout:"column",items:[this.actionTypeCombo,{id:this.idPrefix+"CardLayout",layout:"card",activeItem:this.idPrefix+"fileinto",border:false,columnWidth:0.5,defaults:{border:false},items:[{id:this.idPrefix+"fileinto",layout:"form",items:[{name:"action_argument_fileinto",xtype:"felamimailfolderselect",width:200,hideLabel:true,account:this.account}]},{id:this.idPrefix+"redirect",layout:"form",items:[{name:"action_argument_redirect",xtype:"textfield",emptyText:"test@example.org",width:200,hideLabel:true}]},{id:this.idPrefix+"reject",layout:"form",items:[{name:"action_argument_reject",xtype:"textarea",width:300,height:60,hideLabel:true}]},{id:this.idPrefix+"discard",layout:"fit",items:[]}]}]}]}]}});Tine.Felamimail.sieve.RuleEditDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:700,height:300,name:Tine.Felamimail.sieve.RuleEditDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Felamimail.sieve.RuleEditDialog",contentPanelConstructorConfig:a});return b};Tine.Felamimail.sieve.RuleEditDialog.getActionTypes=function(a){return[["fileinto",a.i18n._("Move mail to folder")],["redirect",a.i18n._("Redirect mail to address")],["reject",a.i18n._("Reject mail with this text")],["discard",a.i18n._("Discard mail")]]};Ext.ns("Tine.Felamimail.sieve");Tine.Felamimail.sieve.RulesGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{account:null,recordClass:Tine.Felamimail.Model.Rule,recordProxy:Tine.Felamimail.rulesBackend,defaultSortInfo:{field:"id",dir:"ASC"},storeRemoteSort:false,evalGrants:false,usePagingToolbar:false,newRecordIcon:"action_new_rule",editDialogClass:Tine.Felamimail.sieve.RuleEditDialog,initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Felamimail");this.initColumns();this.editDialogConfig={account:this.account};this.supr().initComponent.call(this)},getViewRowClass:function(a,b){var c="";if(!a.get("enabled")){c+=" felamimail-sieverule-disabled"}return c},initActions:function(){this.action_moveup=new Ext.Action({text:this.app.i18n._("Move up"),handler:this.onMoveRecord.createDelegate(this,["up"]),scope:this,iconCls:"action_move_up"});this.action_movedown=new Ext.Action({text:this.app.i18n._("Move down"),handler:this.onMoveRecord.createDelegate(this,["down"]),scope:this,iconCls:"action_move_down"});this.action_enable=new Ext.Action({text:this.app.i18n._("Enable"),handler:this.onEnableDisable.createDelegate(this,[true]),scope:this,iconCls:"action_enable"});this.action_disable=new Ext.Action({text:this.app.i18n._("Disable"),handler:this.onEnableDisable.createDelegate(this,[false]),scope:this,iconCls:"action_disable"});this.supr().initActions.call(this)},onEnableDisable:function(b){var c=this.grid.getSelectionModel().getSelections();for(var a=0;a<c.length;a++){c[a].set("enabled",b)}},onMoveRecord:function(b){var g=this.grid.getSelectionModel();if(g.getCount()==1){var d=g.getSelections();record=d[0];var a=this.store.indexOf(record),c=(b=="down")?a+1:a-1,f=this.store.getAt(c);if(f){var e=record.id;switchId=f.id;record.set("id",Ext.id());record.id=Ext.id();f.set("id",e);f.id=e;record.set("id",switchId);record.id=switchId;this.store.commitChanges();this.store.sort("id","ASC");g.selectRecords([record])}}},getActionToolbarItems:function(){return[{xtype:"buttongroup",columns:1,frame:false,items:[this.action_moveup,this.action_movedown]}]},getContextMenuItems:function(){var a=["-",this.action_moveup,this.action_movedown,"-",this.action_enable,this.action_disable];return a},initColumns:function(){this.gridConfig.columns=[{id:"id",header:this.app.i18n._("ID"),width:40,sortable:false,dataIndex:"id",hidden:true},{id:"conditions",header:this.app.i18n._("Conditions"),width:200,sortable:false,dataIndex:"conditions",scope:this,renderer:this.conditionsRenderer},{id:"action",header:this.app.i18n._("Action"),width:250,sortable:false,dataIndex:"action_type",scope:this,renderer:this.actionRenderer}]},initLayout:function(){this.supr().initLayout.call(this);this.items.push({region:"north",height:55,border:false,items:this.actionToolbar})},initialLoad:function(){this.store.load.defer(10,this.store,[typeof this.autoLoad=="object"?this.autoLoad:undefined])},onStoreBeforeload:function(a,b){Tine.Felamimail.sieve.RulesGridPanel.superclass.onStoreBeforeload.call(this,a,b);b.params.filter=this.account.id},actionRenderer:function(e,d,b){var c=Tine.Felamimail.sieve.RuleEditDialog.getActionTypes(this.app),a=e;for(i=0;i<c.length;i++){if(c[i][0]==e){a=c[i][1]}}if(b.get("action_argument")&&b.get("action_argument")!=""){a+=" "+b.get("action_argument")}return Ext.util.Format.htmlEncode(a)},conditionsRenderer:function(e){var a="";if(e&&e.length>0){var h=e[0];var c=Tine.Felamimail.sieve.RuleConditionsPanel.getFilterModel(this.app),g,f,b,d=false;for(b=0;b<c.length;b++){if(h.header==c[b].field){g=c[b].label;if(h.header=="size"){f=(h.comperator=="over")?_("is greater than"):_("is less than")}else{f=_(h.comperator)}d=true}}if(d===true){a=g+" "+f+' "'+h.key+'"'}else{a=String.format(this.app.i18n._('Header "{0}" contains "{1}"'),h.header,h.key)}}return Ext.util.Format.htmlEncode(a)},onUpdateRecord:function(a){var b=Tine.Felamimail.rulesBackend.recordReader({responseText:a});if(!b.id){var d=null,c=null;do{d=this.store.getAt(this.store.getCount()-1);c=(d)?(parseInt(d.id,10)+1).toString():"1"}while(this.store.getById(b.id));b.set("id",c);b.id=c}else{this.store.remove(this.store.getById(b.id))}this.store.addSorted(b);var e=this.getView().getRow(this.store.indexOf(b));Ext.fly(e).highlight()},onDeleteRecords:function(b,c){var d=this.grid.getSelectionModel();var a=d.getSelections();Ext.each(a,function(e){this.store.remove(e)})}});Ext.namespace("Tine.Felamimail.sieve");Tine.Felamimail.sieve.RulesDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{account:null,windowNamePrefix:"VacationEditWindow_",appName:"Felamimail",loadRecord:false,mode:"local",tbarItems:[],evalGrants:false,initComponent:function(){Tine.Felamimail.sieve.RulesDialog.superclass.initComponent.call(this);this.i18nRecordName=this.app.i18n._("Sieve Filter Rules")},updateToolbars:Ext.emptyFn,initRecord:function(){this.onRecordLoad()},onRecordLoad:function(){if(!this.rendered){this.onRecordLoad.defer(250,this);return}var a=String.format(this.app.i18n._("Sieve Filter Rules for {0}"),this.account.get("name"));this.window.setTitle(a);this.loadMask.hide()},getFormItems:function(){this.rulesGrid=new Tine.Felamimail.sieve.RulesGridPanel({account:this.account});return[this.rulesGrid]},onApplyChanges:function(a,c,b){var d=[];this.rulesGrid.store.each(function(e){d.push(e.data)});this.loadMask.show();Tine.Felamimail.rulesBackend.saveRules(this.account.id,d,{scope:this,success:function(e){if(b){this.purgeListeners();this.window.close()}},failure:Tine.Felamimail.handleRequestException.createSequence(function(){this.loadMask.hide()},this),timeout:150000})}});Tine.Felamimail.sieve.RulesDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:800,height:400,name:Tine.Felamimail.sieve.RulesDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Felamimail.sieve.RulesDialog",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Felamimail.sieve");Tine.Felamimail.sieve.RuleConditionsPanel=Ext.extend(Tine.widgets.grid.FilterToolbar,{defaultFilter:"from",allowSaving:false,showSearchButton:false,filterFieldWidth:160,onFiltertrigger:Ext.emptyFn,initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Felamimail");this.rowPrefix="";this.filterModels=Tine.Felamimail.sieve.RuleConditionsPanel.getFilterModel(this.app);this.supr().initComponent.call(this)},getAllFilterData:function(){return this.getValue()}});Tine.Felamimail.sieve.RuleConditionsPanel.getFilterModel=function(a){return[{label:a.i18n._("From"),field:"from",operators:["contains"],emptyText:"test@example.org"},{label:a.i18n._("To"),field:"to",operators:["contains"],emptyText:"test@example.org"},{label:a.i18n._("Subject"),field:"subject",operators:["contains"],emptyText:a.i18n._("Subject")},{label:a.i18n._("Size"),field:"size",operators:["greater","less"],valueType:"number",defaultOperator:"greater"},{label:a.i18n._("Header contains"),field:"header",operators:["freeform"],defaultOperator:"freeform",emptyTextOperator:a.i18n._("Header name"),emptyText:a.i18n._("Header value")}]};Ext.namespace("Tine.Felamimail");Tine.Felamimail.setTreeContextMenus=function(){var g={text:this.app.i18n._("Empty Folder"),iconCls:"action_folder_emptytrash",scope:this,handler:function(){this.ctxNode.getUI().addClass("x-tree-node-loading");var j=this.ctxNode.attributes.folder_id;Ext.Ajax.request({params:{method:"Felamimail.emptyFolder",folderId:j},scope:this,success:function(k,o){var p=this.getSelectionModel().getSelectedNode(),m=(p&&this.ctxNode.id==p.id);if(m){var l=Tine.Felamimail.folderBackend.recordReader(k);this.app.getFolderStore().updateFolder(l)}else{var n=this.app.getFolderStore().getById(j);n.set("cache_unreadcount",0)}this.ctxNode.getUI().removeClass("x-tree-node-loading")},failure:function(){this.ctxNode.getUI().removeClass("x-tree-node-loading")},timeout:120000})}};var f={text:this.app.i18n._("Add Folder"),iconCls:"action_add",scope:this,disabled:true,handler:function(){Ext.MessageBox.prompt(String.format(_("New {0}"),this.app.i18n._("Folder")),String.format(_("Please enter the name of the new {0}:"),this.app.i18n._("Folder")),function(k,l){if(this.ctxNode&&k=="ok"){if(!l){Ext.Msg.alert(String.format(_("No {0} added"),this.app.i18n._("Folder")),String.format(_("You have to supply a {0} name!"),this.app.i18n._("Folder")));return}Ext.MessageBox.wait(_("Please wait"),String.format(_("Creating {0}..."),this.app.i18n._("Folder")));var j=this.ctxNode;var m={method:"Felamimail.addFolder",name:l};m.parent="";m.accountId=j.id;Ext.Ajax.request({params:m,scope:this,success:function(q,o){var n=Ext.util.JSON.decode(q.responseText);var p=this.loader.createNode(n);j.appendChild(p);this.fireEvent("containeradd",n);Ext.MessageBox.hide()}})}},this)}};var e={text:this.app.i18n._("Edit Account"),iconCls:"FelamimailIconCls",scope:this,disabled:!Tine.Tinebase.common.hasRight("manage_accounts","Felamimail"),handler:function(){var j=this.accountStore.getById(this.ctxNode.attributes.account_id);var k=Tine.Felamimail.AccountEditDialog.openWindow({record:j,listeners:{scope:this,update:function(l){var m=new Tine.Felamimail.Model.Account(Ext.util.JSON.decode(l));this.ctxNode.setText(m.get("name"));this.accountStore.reload();this.folderStore.resetQueryAndRemoveRecords("parent_path","/"+this.ctxNode.attributes.account_id);this.ctxNode.reload(function(n){})}}})}};var b={text:this.app.i18n._("Set Vacation Message"),iconCls:"action_email_replyAll",scope:this,handler:function(){var m=this.ctxNode.attributes.account_id;var l=this.accountStore.getById(m);var j=new Tine.Felamimail.Model.Vacation({id:m},m);var k=Tine.Felamimail.sieve.VacationEditDialog.openWindow({account:l,record:j})}};var h={text:this.app.i18n._("Set Filter Rules"),iconCls:"action_email_forward",scope:this,handler:function(){var l=this.ctxNode.attributes.account_id;var k=this.accountStore.getById(l);var j=Tine.Felamimail.sieve.RulesDialog.openWindow({account:k})}};var a={text:this.app.i18n._("Mark Folder as read"),iconCls:"action_mark_read",scope:this,handler:function(){if(this.ctxNode){var j=this.ctxNode.id,l=[{field:"folder_id",operator:"equals",value:j},{field:"flags",operator:"notin",value:["\\Seen"]}];var m=this.getSelectionModel().getSelectedNode(),k=(m&&this.ctxNode.id==m.id);Tine.Felamimail.messageBackend.addFlags(l,"\\Seen",{callback:function(){this.app=Tine.Tinebase.appMgr.get("Felamimail");var n=this.app.getFolderStore().getById(j);n.set("cache_unreadcount",0);if(k){this.app.getMainScreen().getCenterPanel().loadGridData({removeStrategy:"keepBuffered"})}}})}}};var d={text:this.app.i18n._("Update Folder List"),iconCls:"action_update_cache",scope:this,handler:function(){if(this.ctxNode){var j=this.app.getFolderStore().getById(this.ctxNode.id),k=j?Tine.Felamimail.loadAccountStore().getById(j.get("account_id")):Tine.Felamimail.loadAccountStore().getById(this.ctxNode.id);this.ctxNode.getUI().addClass("x-tree-node-loading");Ext.Ajax.request({params:{method:"Felamimail.updateFolderCache",accountId:k.id,folderName:j?j.get("globalname"):""},scope:this,success:function(l,m){this.ctxNode.getUI().removeClass("x-tree-node-loading");this.folderStore.resetQueryAndRemoveRecords("parent_path",(j?j.get("path"):"/")+k.id);this.ctxNode.reload(function(n){this.selectInbox(k)},this)},failure:function(){this.ctxNode.getUI().removeClass("x-tree-node-loading")}})}}};var c={nodeName:this.app.i18n.n_("Folder","Folders",1),scope:this,backend:"Felamimail",backendModel:"Folder"};c.actions=[a,"add"];this.contextMenuSystemFolder=Tine.widgets.tree.ContextMenu.getMenu(c);c.actions=[a,"add","rename","delete"];this.contextMenuUserFolder=Tine.widgets.tree.ContextMenu.getMenu(c);c.actions=[a,"add",g];this.contextMenuTrash=Tine.widgets.tree.ContextMenu.getMenu(c);this.contextMenuAccount=Tine.widgets.tree.ContextMenu.getMenu({nodeName:this.app.i18n.n_("Account","Accounts",1),actions:[f,d,b,h,e,"delete"],scope:this,backend:"Felamimail",backendModel:"Account"});c.actions=["add"];this.unselectableFolder=Tine.widgets.tree.ContextMenu.getMenu(c)};Tine.Felamimail.TreeLoader=Ext.extend(Tine.widgets.tree.Loader,{requestData:function(d,f,b){if(this.fireEvent("beforeload",this,d,f)!==false){var a=Tine.Tinebase.appMgr.get("Felamimail").getFolderStore(),c=a.getById(d.attributes.folder_id),e=(c)?c.get("path"):d.attributes.path;a.asyncQuery("parent_path",e,function(h,k,g,j){if(j){h.beginUpdate();j.each(function(l){var m=this.createNode(l.copy().data);if(m){h.appendChild(m)}},this);h.endUpdate()}this.runCallback(k,g||h,[h])},[d,f,b],this,a)}else{this.runCallback(f,b||d,[])}},inspectCreateNode:function(a){var b=Tine.Felamimail.loadAccountStore().getById(a.account_id);a.has_children=(b&&b.get("has_children_support"))?a.has_children:true;if(a.has_children=="0"){a.has_children=false}Ext.apply(a,{leaf:!a.has_children,expandable:a.has_children,cls:"x-tree-node-collapsed",folder_id:a.id,folderNode:true,allowDrop:true,text:this.app.i18n._hidden(a.localname)});if(b){if(b.get("trash_folder")==a.globalname){if(a.cache_totalcount>0){a.cls="felamimail-node-trash-full"}else{a.cls="felamimail-node-trash"}}if(b.get("sent_folder")==a.globalname){a.cls="felamimail-node-sent"}}if("INBOX"==a.globalname){a.cls="felamimail-node-inbox"}if("Drafts"==a.globalname){a.cls="felamimail-node-drafts"}if("Templates"==a.globalname){a.cls="felamimail-node-templates"}if("Junk"==a.globalname){a.cls="felamimail-node-junk"}}});Ext.namespace("Tine.Felamimail");Tine.Felamimail.FilterPanel=Ext.extend(Tine.widgets.persistentfilter.PickerPanel,{filterModel:"Felamimail_Model_MessageFilter"});Tine.Felamimail.TreePanel=function(a){Ext.apply(this,a);this.addEvents("containeradd","containerdelete","containerrename");Tine.Felamimail.TreePanel.superclass.constructor.call(this)};Ext.extend(Tine.Felamimail.TreePanel,Ext.tree.TreePanel,{app:null,accountStore:null,folderStore:null,containerName:"Folder",rootVisible:false,enableDrop:true,ddGroup:"mailToTreeDDGroup",border:false,recordClass:Tine.Felamimail.Model.Account,filterMode:"filterToolbar",selectContainerPath:Ext.emptyFn,initComponent:function(){this.folderStore=Tine.Tinebase.appMgr.get("Felamimail").getFolderStore();this.loader=new Tine.Felamimail.TreeLoader({folderStore:this.folderStore,app:this.app});this.root=new Ext.tree.TreeNode({text:"default",draggable:false,allowDrop:false,expanded:true,leaf:false,id:"root"});this.initAccounts();this.dropConfig={ddGroup:this.ddGroup||"TreeDD",appendOnly:this.ddAppendOnly===true,notifyEnter:function(){this.isDropSensitive=true}.createDelegate(this),notifyOut:function(){this.isDropSensitive=false}.createDelegate(this),onNodeOver:function(g,b,f,d){var c=g.node;if(!this.expandProcId&&c.attributes.allowDrop&&c.hasChildNodes()&&!c.isExpanded()){this.queueExpand(c)}else{if(!c.attributes.allowDrop){this.cancelExpand()}}return c.attributes.allowDrop?"tinebase-tree-drop-move":false},isValidDropPoint:function(f,b,d,c){return f.node.attributes.allowDrop}};this.selModel=new Ext.tree.MultiSelectionModel({});var a=Tine.Felamimail.setTreeContextMenus.createDelegate(this);a();this.on("beforeclick",this.onBeforeClick,this);this.on("click",this.onClick,this);this.on("contextmenu",this.onContextMenu,this);this.on("beforenodedrop",this.onBeforenodedrop,this);this.on("append",this.onAppend,this);this.on("containeradd",this.onFolderAdd,this);this.on("containerrename",this.onFolderRename,this);this.on("containerdelete",this.onFolderDelete,this);this.selModel.on("selectionchange",this.onSelectionChange,this);this.folderStore.on("update",this.onUpdateFolderStore,this);Tine.Felamimail.TreePanel.superclass.initComponent.call(this)},initAccounts:function(){this.accountStore=Tine.Felamimail.loadAccountStore();this.accountStore.each(this.addAccount,this);this.accountStore.on("update",this.onAccountUpdate,this)},initToolTips:function(){this.folderTip=new Ext.ToolTip({target:this.getEl(),delegate:"a.x-tree-node-anchor",renderTo:document.body,listeners:{beforeshow:this.updateFolderTip.createDelegate(this)}});this.folderProgressTip=new Ext.ToolTip({target:this.getEl(),delegate:".felamimail-node-statusbox-progress",renderTo:document.body,listeners:{beforeshow:this.updateProgressTip.createDelegate(this)}});this.folderUnreadTip=new Ext.ToolTip({target:this.getEl(),delegate:".felamimail-node-statusbox-unread",renderTo:document.body,listeners:{beforeshow:this.updateUnreadTip.createDelegate(this)}})},onSelectionChange:function(d,b){if(this.filterMode=="gridFilter"&&this.filterPlugin){this.filterPlugin.onFilterChange()}if(this.filterMode=="filterToolbar"&&this.filterPlugin){var a=this.filterPlugin.getGridPanel().filterToolbar;if(!a.rendered){this.onSelectionChange.defer(150,this,[d,b]);return}a.supressEvents=true;a.filterStore.each(function(e){var f=e.get("field");if(f==="path"){a.deleteFilter(e)}},this);a.supressEvents=false;var c=this.getFilterPlugin().getFilter();a.addFilter(new a.record(c));a.onFiltertrigger();d.suspendEvents();Ext.each(b,function(e){d.select(e,Ext.EventObject,true)},this);d.resumeEvents()}},onFilterChange:function(){var a=this.getSelectionModel();a.suspendEvents();a.clearSelections();a.resumeEvents()},getFilterPlugin:function(){if(!this.filterPlugin){this.filterPlugin=new Tine.widgets.tree.FilterPlugin({treePanel:this,field:"path",nodeAttributeField:"path",singleNodeOperator:"in"})}return this.filterPlugin},afterRender:function(){Tine.Felamimail.TreePanel.superclass.afterRender.call(this);this.initToolTips();this.selectInbox();if(this.filterMode=="filterToolbar"&&this.filterPlugin){this.filterPlugin.getGridPanel().filterToolbar.on("change",this.onFilterChange,this)}},selectInbox:function(a){var b=(a)?a.id:Tine.Felamimail.registry.get("preferences").get("defaultEmailAccount");this.expandPath("/root/"+b+"/",null,function(d,c){Ext.each(c.childNodes,function(e){if(Ext.util.Format.lowercase(e.attributes.localname)=="inbox"){e.select();return false}},this)})},onAccountUpdate:function(b,a,c){if(c===Ext.data.Record.EDIT){this.updateAccountStatus(a)}},onAppend:function(a,c,d,b){d.ui.render=d.ui.render.createSequence(function(){var f=Tine.Tinebase.appMgr.get("Felamimail"),e=f.getFolderStore().getById(d.id);if(e){f.getMainScreen().getTreePanel().addStatusboxesToNodeUi(this);f.getMainScreen().getTreePanel().updateFolderStatus(e)}},d.ui)},addStatusboxesToNodeUi:function(a){Ext.DomHelper.insertAfter(a.elNode.lastChild,{tag:"span","class":"felamimail-node-statusbox",cn:[{tag:"img",src:Ext.BLANK_IMAGE_URL,"class":"felamimail-node-statusbox-progress"},{tag:"span","class":"felamimail-node-statusbox-unread"}]})},onBeforeClick:function(a){if(Tine.Felamimail.loadAccountStore().getById(a.id)||!this.app.getFolderStore().getById(a.id).get("is_selectable")){return false}},onClick:function(b){if(b.expandable){b.expand()}if(b.id&&b.id!="/"&&b.attributes.globalname!=""){var a=this.app.getFolderStore().getById(b.id);this.app.checkMailsDelayedTask.delay(0)}},onContextMenu:function(c,b){this.ctxNode=c;var a=this.app.getFolderStore().getById(c.id),d=a?Tine.Felamimail.loadAccountStore().getById(a.get("account_id")):Tine.Felamimail.loadAccountStore().getById(c.id);if(!a){if(d.get("ns_personal")!=="default"){this.contextMenuAccount.items.each(function(e){if(e.iconCls=="action_add"){e.setDisabled(d.get("ns_personal")!="")}if(e.iconCls=="action_email_replyAll"||e.iconCls=="action_email_forward"){e.setDisabled(d.get("sieve_hostname")==null||d.get("sieve_hostname")=="")}});this.contextMenuAccount.showAt(b.getXY())}}else{if(a.get("globalname")===d.get("trash_folder")||a.get("globalname").match(/junk/i)){this.contextMenuTrash.showAt(b.getXY())}else{if(!a.get("is_selectable")){this.unselectableFolder.showAt(b.getXY())}else{if(a.get("system_folder")){this.contextMenuSystemFolder.showAt(b.getXY())}else{this.contextMenuUserFolder.showAt(b.getXY())}}}}},onBeforenodedrop:function(a){var c=a.target.attributes.folder_id,b=this.app.getFolderStore().getById(c);this.app.getMainScreen().getCenterPanel().moveSelectedMessages(b,false);return true},onDestroy:function(){this.folderStore.un("update",this.onUpdateFolderStore,this)},onUpdateFolderStore:function(c,a,b){if(b===Ext.data.Record.EDIT){this.updateFolderStatus(a)}},onFolderAdd:function(c){var a=Ext.copyTo({},c,Tine.Felamimail.Model.Folder.getFieldNames());var b=Tine.Felamimail.folderBackend.recordReader({responseText:Ext.util.JSON.encode(a)});Tine.log.debug("Added new folder:"+b.get("globalname"));this.folderStore.add([b]);var d=this.getNodeById(b.id);d.attributes.path=b.get("path");d.attributes.parent_path=b.get("parent_path");this.addStatusboxesToNodeUi(d.ui);this.updateFolderStatus(b)},onFolderRename:function(b){var a=this.folderStore.getById(b.id);a.set("globalname",b.globalname);a.set("localname",b.localname);Tine.log.debug("Renamed folder:"+a.get("globalname"))},onFolderDelete:function(a){this.folderStore.remove(this.folderStore.getById(a.id))},getElsParentsNodeId:function(a){return Ext.fly(a,"_treeEvents").up("div[class^=x-tree-node-el]").getAttribute("tree-node-id","ext")},updateAccountStatus:function(f){var c=f.get("imap_status"),d=this.getNodeById(f.id),e=d?d.getUI():null,b=e?e.getEl():null;Tine.log.info("Account "+f.get("name")+" updated with imap_status: "+c);if(d&&d.ui.rendered){var a=Ext.get(Ext.DomQuery.selectNode("span[class=felamimail-node-accountfailure]",b));if(!a){a=Ext.DomHelper.insertAfter(e.elNode.lastChild,{tag:"span","class":"felamimail-node-accountfailure"},true);a.on("click",function(){Tine.Felamimail.folderBackend.handleRequestException(f.getLastIMAPException())},this)}a.setVisible(c==="failure")}},updateFolderStatus:function(c){var h=c.get("cache_unreadcount"),a=Math.round(c.get("cache_job_actions_done")/c.get("cache_job_actions_estimate")*10)*10,d=this.getNodeById(c.id),j=d?d.getUI():null,e=j?j.getEl():null,g=c.get("cache_status"),l=c.modified?c.modified.cache_status:null,b=c.isCurrentSelection();if(d&&d.ui.rendered){var f=Ext.DomQuery.selectNode("span[class=felamimail-node-statusbox-unread]",e);if(f){Ext.fly(f).update(h).setVisible(h>0);j[h===0?"removeClass":"addClass"]("felamimail-node-unread");var k=Ext.get(Ext.DomQuery.selectNode("img[class^=felamimail-node-statusbox-progress]",e));k.removeClass(["felamimail-node-statusbox-progress-pie","felamimail-node-statusbox-progress-loading"]);if(!Ext.isNumber(a)){k.setStyle("background-position",0+"px");k.addClass("felamimail-node-statusbox-progress-loading")}else{k.setStyle("background-position",a+"%");k.addClass("felamimail-node-statusbox-progress-pie")}k.setVisible(b&&g!=="complete"&&g!=="disconnect"&&a!==100&&l!=="complete")}}},updateFolderTip:function(d){var a=this.getElsParentsNodeId(d.triggerElement),b=this.app.getFolderStore().getById(a),c=Tine.Felamimail.loadAccountStore().getById(a);if(b&&!this.isDropSensitive){var e=["<table>","<tr>","<td>",this.app.i18n._("Total Messages:"),"</td>","<td>",b.get("cache_totalcount"),"</td>","</tr>","<tr>","<td>",this.app.i18n._("Unread Messages:"),"</td>","<td>",b.get("cache_unreadcount"),"</td>","</tr>","<tr>","<td>",this.app.i18n._("Name on Server:"),"</td>","<td>",b.get("globalname"),"</td>","</tr>","<tr>","<td>",this.app.i18n._("Last update:"),"</td>","<td>",Tine.Tinebase.common.dateTimeRenderer(b.get("client_access_time")),"</td>","</tr>","</table>"];d.body.dom.innerHTML=e.join("")}else{return false}},updateProgressTip:function(d){var a=this.getElsParentsNodeId(d.triggerElement),c=this.app.getFolderStore().getById(a),b=Math.round(c.get("cache_job_actions_done")/c.get("cache_job_actions_estimate")*100);if(!this.isDropSensitive){d.body.dom.innerHTML=String.format(this.app.i18n._("Fetching messages... ({0}% done)"),b)}else{return false}},updateUnreadTip:function(d){var a=this.getElsParentsNodeId(d.triggerElement),c=this.app.getFolderStore().getById(a),b=c.get("cache_unreadcount");if(!this.isDropSensitive){d.body.dom.innerHTML=String.format(this.app.i18n.ngettext("{0} unread message","{0} unread messages",b),b)}else{return false}},decrementCurrentUnreadCount:function(){var a=Tine.Tinebase.appMgr.get("Felamimail").getFolderStore(),c=this.getSelectionModel().getSelectedNode(),b=c?a.getById(c.id):null;if(b){b.set("cache_unreadcount",parseInt(b.get("cache_unreadcount"),10)-1);b.commit()}},addAccount:function(a){var b=new Ext.tree.AsyncTreeNode({id:a.data.id,path:"/"+a.data.id,record:a,globalname:"",draggable:false,allowDrop:false,expanded:false,text:a.get("name"),qtip:a.get("host"),leaf:false,cls:"felamimail-node-account",delimiter:a.get("delimiter"),ns_personal:a.get("ns_personal"),account_id:a.data.id,listeners:{scope:this,load:function(c){var d=Tine.Felamimail.loadAccountStore().getById(c.id);this.updateAccountStatus(d)}}});this.suspendEvents();this.root.appendChild(b);this.resumeEvents()},getActiveAccount:function(){var a=null;var b=this.getSelectionModel().getSelectedNode();if(b){var c=b.attributes.account_id;a=this.accountStore.getById(c)}return a}});Ext.namespace("Tine.Felamimail");Tine.Felamimail.GridDetailsPanel=Ext.extend(Tine.widgets.grid.DetailsPanel,{defaultHeight:300,currentId:null,record:null,app:null,i18n:null,fetchBodyTransactionId:null,initComponent:function(){this.initTemplate();this.defaultTpl=new Ext.XTemplate('<div class="preview-panel-felamimail">','<div class="preview-panel-felamimail-body">{[values ? values.msg : ""]}</div>',"</div>");Tine.Felamimail.GridDetailsPanel.superclass.initComponent.call(this)},afterRender:function(){Tine.Felamimail.GridDetailsPanel.superclass.afterRender.apply(this,arguments);this.body.on("click",this.onClick,this)},updateDetails:function(b,a){if(b.id===this.currentId){return}if(!b.bodyIsFetched()){if(!this.grid||this.grid.getSelectionModel().getCount()==1){this.refetchBody(b,this.updateDetails.createDelegate(this,[b,a]),"updateDetails");this.defaultTpl.overwrite(a,{msg:""});this.getLoadMask().show()}else{this.getLoadMask().hide()}return}if(b===this.record){this.currentId=b.id;this.tpl.overwrite(a,b.data);this.getLoadMask().hide();this.getEl().down("div").down("div").scrollTo("top",0,false)}},refetchBody:function(a,c,b){if(this.fetchBodyTransactionId&&!Tine.Felamimail.messageBackend.isLoading(this.fetchBodyTransactionId)){Tine.log.debug("Tine.Felamimail.GridDetailsPanel::"+b+"() cancelling current fetchBody request.");Tine.Felamimail.messageBackend.abort(this.fetchBodyTransactionId)}this.fetchBodyTransactionId=Tine.Felamimail.messageBackend.fetchBody(a,c)},initTemplate:function(){this.tpl=new Ext.XTemplate('<div class="preview-panel-felamimail">','<div class="preview-panel-felamimail-headers">',"<b>"+this.i18n._("Subject")+":</b> {[this.encode(values.subject)]}<br/>","<b>"+this.i18n._("From")+":</b>",' {[this.showFrom(values.from_email, values.from_name, "'+this.i18n._("Add")+'", "'+this.i18n._("Add contact to addressbook")+'")]}<br/>',"<b>"+this.i18n._("Date")+":</b> {[this.encode(values.received)]}","{[this.showRecipients(values.headers)]}",'{[this.showHeaders("'+this.i18n._("Show or hide header information")+'")]}',"</div>",'<div class="preview-panel-felamimail-attachments">{[this.showAttachments(values.attachments, values)]}</div>','<div class="preview-panel-felamimail-body">{[this.showBody(values.body, values)]}</div>',"</div>",{app:this.app,panel:this,encode:function(a){if(a){var b=Ext.util.Format.htmlEncode(a);b=Ext.util.Format.nl2br(b);b=b.replace(/ /g,"&nbsp;");return b}else{return""}return a},showFrom:function(f,a,h,c){if(a===null){return""}var j=this.encode(a+" <"+f+">");var b=Ext.id()+":"+f;var g=a.match(/^"*([^,^ ]+)(,*) *(.+)/i);var d=(g&&g[1])?g[1]:"";var e=(g&&g[3])?g[3]:"";if(g&&g[2]==","){d=e;e=g[1]}b+=Ext.util.Format.htmlEncode(":"+Ext.util.Format.trim(d)+":"+Ext.util.Format.trim(e));j+=' <span ext:qtip="'+c+'" id="'+b+'" class="tinebase-addtocontacts-link">[+]</span>';return j},showBody:function(b,d){b=b||"";if(b){var e=this.app.getActiveAccount();if(e.get("display_format")=="plain"||(e.get("display_format")=="content_type"&&d.body_content_type=="text/plain")){var c=this.panel.body.getWidth()-25,a=this.panel.body.getHeight()-90,f=Ext.id();if(a<0){a=500}b='<textarea style="width: '+c+"px; height: "+a+'px; " autocomplete="off" id="'+f+'" name="body" class="x-form-textarea x-form-field x-ux-display-background-border" readonly="" >'+b+"</textarea>"}}return b},showHeaders:function(b){var a=' <span ext:qtip="'+b+'" id="'+Ext.id()+':show" class="tinebase-showheaders-link">[...]</span>';return a},showRecipients:function(c){if(c){var b=Tine.Tinebase.appMgr.get("Felamimail").i18n,a="";for(header in c){if(c.hasOwnProperty(header)&&(header=="to"||header=="cc"||header=="bcc")){a+="<br/><b>"+b._hidden(Ext.util.Format.capitalize(header))+":</b> "+Ext.util.Format.htmlEncode(c[header])}}return a}else{return""}},showAttachments:function(e,d){var a=(e.length>0)?"<b>"+this.app.i18n._("Attachments")+":</b> ":"";for(var c=0,f,b;c<e.length;c++){a+='<span id="'+Ext.id()+":"+c+'" class="tinebase-download-link"><i>'+e[c].filename+"</i> ("+Ext.util.Format.fileSize(e[c].size)+")</span> "}return a}})},onClick:function(l){var s=["span[class=tinebase-download-link]","a[class=tinebase-email-link]","span[class=tinebase-addtocontacts-link]","span[class=tinebase-showheaders-link]"];for(var h=0,m=null,b="";h<s.length;h++){m=l.getTarget(s[h]);if(m){b=s[h];break}}switch(b){case"span[class=tinebase-download-link]":var q=m.id.split(":")[1];attachment=this.record.get("attachments")[q];if(!this.record.bodyIsFetched()){this.refetchBody(this.record,this.onClick.createDelegate(this,[l]),"onClick");return}var o=(this.record.id.match(/_/))?this.record.id.split("_")[0]:this.record.id;if(attachment["content-type"]==="message/rfc822"){Tine.Felamimail.MessageDisplayDialog.openWindow({record:new Tine.Felamimail.Model.Message({id:o+"_"+attachment.partId})})}else{new Ext.ux.file.Download({params:{requestType:"HTTP",method:"Felamimail.downloadAttachment",messageId:o,partId:attachment.partId}}).start()}break;case"a[class=tinebase-email-link]":var p=m.id.split(":")[1];var f=Tine.Felamimail.Model.Message.getDefaultData();f.to=[p];f.body=Tine.Felamimail.getSignature();var k=new Tine.Felamimail.Model.Message(f,0);var d=Tine.Felamimail.MessageEditDialog.openWindow({record:k});break;case"span[class=tinebase-addtocontacts-link]":if(!Tine.Addressbook||!Tine.Tinebase.common.hasRight("run","Addressbook")){return}var a=Ext.util.Format.htmlDecode(m.id);var g=a.split(":");var d=Tine.Addressbook.ContactEditDialog.openWindow({listeners:{scope:this,load:function(e){e.record.set("email",g[1]);e.record.set("n_given",g[2]);e.record.set("n_family",g[3])}}});break;case"span[class=tinebase-showheaders-link]":var g=m.id.split(":");var r=g[0];var c=g[1];var j="";if(c=="show"){var n=this.record.get("headers");for(header in n){if(n.hasOwnProperty(header)&&(header!="to"||header!="cc"||header!="bcc")){j+="<br/><b>"+header+":</b> "+Ext.util.Format.htmlEncode(n[header])}}m.id=r+":hide"}else{j=' <span ext:qtip="'+this.i18n._("Show or hide header information")+'" id="'+Ext.id()+':show" class="tinebase-showheaders-link">[...]</span>'}m.innerHTML=j;break}}});Ext.namespace("Tine.Felamimail");Tine.Felamimail.GridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Felamimail.Model.Message,detailsPanel:null,deleteTransactionId:null,evalGrants:false,filterSelectionDelete:true,defaultSortInfo:{field:"received",direction:"DESC"},gridConfig:{autoExpandColumn:"subject",enableDragDrop:true,ddGroup:"mailToTreeDDGroup"},updateDetailsPanelOnCtxMenu:false,getViewRowClass:function(a,b){var c="";if(a.hasFlag("\\Flagged")){c+=" flag_flagged"}if(a.hasFlag("\\Deleted")){c+=" flag_deleted"}if(!a.hasFlag("\\Seen")){c+=" flag_unread"}return c},initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Felamimail");this.i18nEmptyText=this.app.i18n._("No Messages found or the cache is empty.");this.recordProxy=Tine.Felamimail.messageBackend;this.gridConfig.columns=this.getColumns();this.initFilterToolbar();this.initDetailsPanel();this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);this.pagingConfig={doRefresh:this.doRefresh.createDelegate(this)};Tine.Felamimail.GridPanel.superclass.initComponent.call(this);this.grid.getSelectionModel().on("rowselect",this.onRowSelection,this);this.app.getFolderStore().on("update",this.onUpdateFolderStore,this)},onDestroy:function(){this.app.getFolderStore().un("update",this.onUpdateFolderStore,this)},onUpdateFolderStore:function(d,b,c){if(c===Ext.data.Record.EDIT&&b.isModified("cache_totalcount")){var a=this.app.getMainScreen().getTreePanel(),h=(a)?a.getSelectionModel().getSelectedNodes():[];if(this.getGrid().getSelectionModel().getCount()<=1){var f=false;for(var e=0;e<h.length;e++){if(h[e].id==b.id){f=true;break}}if(!f){var g=this.filterToolbar.getValue();for(var e=0;e<g.length;e++){if(g[e].field=="path"&&g[e].operator=="in"){if(g[e].value.indexOf(b.get("path"))!==-1||(g[e].value.indexOf("/allinboxes")!==-1&&b.isInbox())){f=true;break}}}}if(f){this.loadGridData({removeStrategy:"keepBuffered"})}}}},initialLoad:function(){var a=this.app.getActiveAccount(),c=a?a.id:null,b=c?this.app.getFolderStore().queryBy(function(d){return d.get("account_id")===c&&d.get("localname")==="INBOX"},this).first():null;if(!b){this.initialLoad.defer(100,this,arguments);return}return Tine.Felamimail.GridPanel.superclass.initialLoad.apply(this,arguments)},initActions:function(){this.action_write=new Ext.Action({requiredGrant:"addGrant",actionType:"add",text:this.app.i18n._("Compose"),handler:this.onMessageCompose.createDelegate(this),iconCls:this.app.appName+"IconCls"});this.action_reply=new Ext.Action({requiredGrant:"readGrant",actionType:"reply",text:this.app.i18n._("Reply"),handler:this.onMessageReplyTo.createDelegate(this,[false]),iconCls:"action_email_reply",disabled:true});this.action_replyAll=new Ext.Action({requiredGrant:"readGrant",actionType:"replyAll",text:this.app.i18n._("Reply To All"),handler:this.onMessageReplyTo.createDelegate(this,[true]),iconCls:"action_email_replyAll",disabled:true});this.action_forward=new Ext.Action({requiredGrant:"readGrant",actionType:"forward",text:this.app.i18n._("Forward"),handler:this.onMessageForward.createDelegate(this),iconCls:"action_email_forward",disabled:true});this.action_flag=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._("Toggle highlighting"),handler:this.onToggleFlag.createDelegate(this,["\\Flagged"],true),iconCls:"action_email_flag",allowMultiple:true,disabled:true});this.action_markUnread=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._("Mark read/unread"),handler:this.onToggleFlag.createDelegate(this,["\\Seen"],true),iconCls:"action_mark_read",allowMultiple:true,disabled:true});this.action_deleteRecord=new Ext.Action({requiredGrant:"deleteGrant",allowMultiple:true,singularText:this.app.i18n._("Delete"),pluralText:this.app.i18n._("Delete"),translationObject:this.i18nDeleteActionText?this.app.i18n:Tine.Tinebase.translation,text:this.app.i18n._("Delete"),handler:this.onDeleteRecords,disabled:true,iconCls:"action_delete",scope:this});this.action_addAccount=new Ext.Action({text:this.app.i18n._("Add Account"),handler:this.onAddAccount,iconCls:"action_add",scope:this,disabled:!Tine.Tinebase.common.hasRight("add_accounts","Felamimail")});this.action_printPreview=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._("Print Preview"),handler:this.onPrintPreview.createDelegate(this,[]),disabled:true,iconCls:"action_printPreview",scope:this});this.action_print=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._("Print Message"),handler:this.onPrint.createDelegate(this,[]),disabled:true,iconCls:"action_print",scope:this,menu:{items:[this.action_printPreview]}});this.actionUpdater.addActions([this.action_write,this.action_deleteRecord,this.action_reply,this.action_replyAll,this.action_forward,this.action_flag,this.action_markUnread,this.action_addAccount,this.action_print,this.action_printPreview]);this.contextMenu=new Ext.menu.Menu({items:[this.action_reply,this.action_replyAll,this.action_forward,this.action_flag,this.action_markUnread,this.action_deleteRecord]})},initFilterToolbar:function(){this.filterToolbar=new Tine.widgets.grid.FilterToolbar({filterModels:Tine.Felamimail.Model.Message.getFilterModel(),defaultFilter:"query",filters:[],plugins:[new Tine.widgets.grid.FilterToolbarQuickFilterPlugin({criteriaIgnores:[{field:"query",operator:"contains",value:""},{field:"id"}]})]})},initDetailsPanel:function(){this.detailsPanel=new Tine.Felamimail.GridDetailsPanel({gridpanel:this,grid:this,app:this.app,i18n:this.app.i18n})},getActionToolbar:function(){if(!this.actionToolbar){this.actionToolbar=new Ext.Toolbar({defaults:{height:55},items:[{xtype:"buttongroup",columns:8,items:[Ext.apply(new Ext.Button(this.action_write),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_deleteRecord),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_reply),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_replyAll),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_forward),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.SplitButton(this.action_print),{scale:"medium",rowspan:2,iconAlign:"top",arrowAlign:"right"}),this.action_flag,this.action_addAccount,this.action_markUnread]},this.getActionToolbarItems()]});if(this.filterToolbar&&typeof this.filterToolbar.getQuickFilterField=="function"){this.actionToolbar.add("->",this.filterToolbar.getQuickFilterField())}}return this.actionToolbar},getColumns:function(){return[{id:"id",header:this.app.i18n._("Id"),width:100,sortable:true,dataIndex:"id",hidden:true},{id:"content_type",header:this.app.i18n._("Attachments"),width:12,sortable:true,dataIndex:"content_type",renderer:this.attachmentRenderer},{id:"flags",header:this.app.i18n._("Flags"),width:24,sortable:true,dataIndex:"flags",renderer:this.flagRenderer},{id:"subject",header:this.app.i18n._("Subject"),width:300,sortable:true,dataIndex:"subject"},{id:"from_email",header:this.app.i18n._("From (Email)"),width:100,sortable:true,dataIndex:"from_email"},{id:"from_name",header:this.app.i18n._("From (Name)"),width:100,sortable:true,dataIndex:"from_name"},{id:"sender",header:this.app.i18n._("Sender"),width:100,sortable:true,dataIndex:"sender",hidden:true},{id:"to",header:this.app.i18n._("To"),width:150,sortable:true,dataIndex:"to",hidden:true},{id:"sent",header:this.app.i18n._("Sent"),width:100,sortable:true,dataIndex:"sent",hidden:true,renderer:Tine.Tinebase.common.dateTimeRenderer},{id:"received",header:this.app.i18n._("Received"),width:100,sortable:true,dataIndex:"received",renderer:Tine.Tinebase.common.dateTimeRenderer},{id:"folder_id",header:this.app.i18n._("Folder"),width:100,sortable:true,dataIndex:"folder_id",hidden:true,renderer:this.accountAndFolderRenderer.createDelegate(this)},{id:"size",header:this.app.i18n._("Size"),width:80,sortable:true,dataIndex:"size",hidden:true,renderer:Ext.util.Format.fileSize}]},attachmentRenderer:function(b){var a="";if(b&&b.match(/multipart\/mixed/)){a='<img class="FelamimailFlagIcon" src="images/oxygen/16x16/actions/attach.png">'}return a},flagRenderer:function(e,d,b){var c=[],a="";if(b.hasFlag("\\Answered")){c.push({src:"images/oxygen/16x16/actions/mail-reply-sender.png",qtip:_("Answered")})}if(b.hasFlag("Passed")){c.push({src:"images/oxygen/16x16/actions/mail-forward.png",qtip:_("Forwarded")})}Ext.each(c,function(f){a+='<img class="FelamimailFlagIcon" src="'+f.src+'" ext:qtip="'+f.qtip+'">'},this);return a},accountAndFolderRenderer:function(c,d,b){var f=this.app.getFolderStore(),g=Tine.Felamimail.loadAccountStore().getById(b.get("account_id")),a=(g)?g.get("name"):b.get("account_id"),e=f.getById(c);if(!e){e=f.getById(b.id);if(!e){return(a)?a:b.get("name")}}a+="/";if(e){a+=e.get("globalname")}else{a+=c}return a},doRefresh:function(){var a=this.app.getMainScreen().getTreePanel(),d=a?a.getSelectionModel().getSelectedNode():null,c=d?this.app.getFolderStore().getById(d.id):null,b=this.pagingToolbar.refresh;this.editBuffer=[];if(c){b.disable();Tine.log.info('user forced mail check for folder "'+c.get("localname")+'"');this.app.checkMails(c,function(){b.enable()})}else{this.filterToolbar.onFilterChange()}},deleteSelectedMessages:function(){this.moveOrDeleteMessages(null)},moveSelectedMessages:function(a,b){if(a.isCurrentSelection()){return}this.moveOrDeleteMessages(a,b)},moveOrDeleteMessages:function(b,e){var d=this.getGrid().getSelectionModel(),c=d.getSelectionFilter(),f=[];if(d.isFilterSelect){var h=this.getStore(),j=null}else{var h=d.getSelectionsCollection();if(d.getCount()==1&&this.getStore().getCount()>1){lastIdx=this.getStore().indexOf(h.last());j=this.getStore().getAt(lastIdx+1);if(!j){j=this.getStore().getAt(lastIdx-1)}}}var g=0;h.each(function(m){var k=m.hasFlag("\\Seen"),n=this.app.getFolderStore().getById(m.get("folder_id")),l=k?0:1;if(n){n.set("cache_unreadcount",n.get("cache_unreadcount")-l)}if(b){g+=l}f.push(m.id);this.getStore().remove(m)},this);if(b&&g>0){b.set("cache_unreadcount",b.get("cache_unreadcount")+g)}this.deleteQueue=this.deleteQueue.concat(f);this.pagingToolbar.refresh.disable();if(j!==null){d.selectRecords([j])}if(b!==null){var a=(e)?"_trash_":b.id;this.deleteTransactionId=Tine.Felamimail.messageBackend.moveMessages(c,a,{callback:this.onAfterDelete.createDelegate(this,[f,b])})}else{this.deleteTransactionId=Tine.Felamimail.messageBackend.addFlags(c,"\\Deleted",{callback:this.onAfterDelete.createDelegate(this,[f])})}},onAfterCompose:function(a,e,g){a=Ext.isString(a)?new this.recordClass(Ext.decode(a)):a;if(Ext.isString(g)){var d=[],b=this.getStore();Ext.each(Ext.decode(g),function(j){var k=b.getById(j.id);if(k){d.push(k)}},this);g=d}var h=Tine.Felamimail.loadAccountStore().getById(a.get("account_id")),f=h?h.getSendFolderId():null,c=f?this.app.getFolderStore().getById(f):null;if(c){c.set("cache_status","incomplete")}if(Ext.isArray(g)){Ext.each(g,function(j){if(["reply","forward"].indexOf(e)!==-1){j.addFlag(e==="reply"?"\\Answered":"Passed")}else{if(e=="senddraft"){this.deleteTransactionId=Tine.Felamimail.messageBackend.addFlags(j.id,"\\Deleted",{callback:this.onAfterDelete.createDelegate(this,[[j.id]])})}}},this)}},onAfterDelete:function(a,b){this.editBuffer=this.editBuffer.diff(a);if(!this.deleteTransactionId||!Tine.Felamimail.messageBackend.isLoading(this.deleteTransactionId)){this.loadGridData({removeStrategy:"keepBuffered"})}},onMessageCompose:function(){Tine.Felamimail.MessageEditDialog.openWindow({listeners:{update:this.onAfterCompose.createDelegate(this,["compose"],1)}})},onMessageForward:function(){var c=this.getGrid().getSelectionModel(),a=c.getSelections(),b=[];Ext.each(a,function(d){b.push(d.data)},this);if(c.getCount()>0){Tine.Felamimail.MessageEditDialog.openWindow({forwardMsgs:Ext.encode(b),listeners:{update:this.onAfterCompose.createDelegate(this,["forward",a],1)}})}},onMessageReplyTo:function(a){var c=this.getGrid().getSelectionModel(),b=c.getSelected();Tine.Felamimail.MessageEditDialog.openWindow({replyTo:Ext.encode(b.data),replyToAll:a,listeners:{update:this.onAfterCompose.createDelegate(this,["reply",[b]],1)}})},onDeleteRecords:function(){var c=this.app.getActiveAccount(),b=c.getTrashFolderId(),a=b?this.app.getFolderStore().getById(b):null;return a&&!a.isCurrentSelection()?this.moveSelectedMessages(a,true):this.deleteSelectedMessages()},onRowSelection:function(d,c,a,b){if(!b){return this.onRowSelection.defer(250,this,[d,c,a,true])}if(d.getCount()==1&&d.isIdSelected(a.id)&&!a.hasFlag("\\Seen")){a.addFlag("\\Seen");Tine.Felamimail.messageBackend.addFlags(a.id,"\\Seen");this.app.getMainScreen().getTreePanel().decrementCurrentUnreadCount()}},onRowDblClick:function(b,g,f){var a=this.grid.getSelectionModel().getSelected(),c=this.app.getFolderStore().getById(a.get("folder_id")),d=Tine.Felamimail.loadAccountStore().getById(c.get("account_id"));action=(c.get("globalname")==d.get("drafts_folder"))?"senddraft":c.get("globalname")==d.get("templates_folder")?"sendtemplate":null;if(action!==null){Tine.Felamimail.MessageEditDialog.openWindow({draftOrTemplate:Ext.encode(a.data),listeners:{scope:this,update:this.onAfterCompose.createDelegate(this,[action,[a]],1)}})}else{Tine.Felamimail.MessageDisplayDialog.openWindow({record:a,listeners:{scope:this,update:this.onAfterCompose,remove:this.onRemoveInDisplayDialog}})}},onRemoveInDisplayDialog:function(a){var b=this.getStore().getById(Ext.decode(a).id);folderId=b?b.get("folder_id"):null,folder=folderId?this.app.getFolderStore().getById(folderId):null,accountId=folder?folder.get("account_id"):null,account=accountId?Tine.Felamimail.loadAccountStore().getById(accountId):null,trashId=account?account.getTrashFolderId():null,trash=trashId?this.app.getFolderStore().getById(trashId):null;this.getStore().remove(b);this.onAfterDelete(null,trash)},onStoreUpdate:function(c,a,b){if(b===Ext.data.Record.EDIT&&a.isModified("flags")){a.commit()}},onKeyDown:function(a){if(a.ctrlKey){switch(a.getKey()){case a.N:case a.M:this.onMessageCompose();a.preventDefault();break;case a.R:this.onMessageReplyTo();a.preventDefault();break;case a.L:this.onMessageForward();a.preventDefault();break}}Tine.Felamimail.GridPanel.superclass.onKeyDown.call(this,a)},onToggleFlag:function(b,g,a){var j=this.getGrid().getSelectionModel(),c=j.getSelectionFilter(),f=j.isFilterSelect?this.getStore():j.getSelectionsCollection(),h=0;f.each(function(e){h+=e.hasFlag(a)?1:0});var d=h>=Math.round(f.getCount()/2)?"clear":"add";f.each(function(m){if(a==="\\Seen"){var e=m.hasFlag("\\Seen"),k=this.app.getFolderStore().getById(m.get("folder_id")),l=(d==="clear"&&e)?1:(d==="add"&&!e)?-1:0;if(k){k.set("cache_unreadcount",k.get("cache_unreadcount")+l);k.commit()}}m[d+"Flag"](a);this.addToEditBuffer(m)},this);Tine.Felamimail.messageBackend[d+"Flags"](c,a)},onStoreBeforeload:function(a,b){this.supr().onStoreBeforeload.apply(this,arguments);if(!Ext.isEmpty(this.deleteQueue)){b.params.filter.push({field:"id",operator:"notin",value:this.deleteQueue})}},onAddAccount:function(b,c){var a=Tine.Felamimail.AccountEditDialog.openWindow({record:null,listeners:{scope:this,update:function(e){var g=new Tine.Felamimail.Model.Account(Ext.util.JSON.decode(e));Tine.Felamimail.registry.get("preferences").replace("defaultEmailAccount",g.id);var d=Tine.Felamimail.registry.get("accounts");d.results.push(g.data);d.totalcount++;Tine.Felamimail.registry.replace("accounts",d);var f=this.app.getMainScreen().getTreePanel();f.addAccount(g);f.accountStore.add([g])}}})},onPrint:function(a){if(!Ext.get("felamimailPrintHelperIframe")){Ext.getBody().createChild({id:"felamimailPrintHelper",tag:"div",children:[{tag:"iframe",id:"felamimailPrintHelperIframe"}]})}var b=this.getDetailsPanelContentForPrinting(a||this.detailsPanel);Ext.get("felamimailPrintHelperIframe").dom.contentWindow.document.documentElement.innerHTML=b;Ext.get("felamimailPrintHelperIframe").dom.contentWindow.print()},getDetailsPanelContentForPrinting:function(b){var d=b.getEl().query(".preview-panel-felamimail");var c=(d.length>1)?d[1].innerHTML:d[0].innerHTML;var a="<html><head>";a+="<title>"+this.app.i18n._("Print Preview")+"</title>";a+="</head><body>";a+=c;a+="</body></html>";return a},onPrintPreview:function(a){var b=this.getDetailsPanelContentForPrinting(a||this.detailsPanel);var c=window.open("about:blank",this.app.i18n._("Print Preview"),"width=500,height=500,scrollbars=yes,toolbar=yes,status=yes,menubar=yes");c.document.open();c.document.write(b);c.document.close();c.focus()},formatHeaders:function(c,b,d){var a="";for(header in c){if(c.hasOwnProperty(header)&&(!d||header=="from"||header=="to"||header=="subject"||header=="date")){a+="<b>"+header+":</b> "+Ext.util.Format.htmlEncode((b)?Ext.util.Format.ellipsis(c[header],40):c[header])+"<br/>"}}return a}});Ext.ns("Tine.Felamimail");Tine.Felamimail.MessageDisplayDialog=Ext.extend(Tine.Felamimail.GridDetailsPanel,{record:null,autoScroll:false,initComponent:function(){this.addEvents("remove");this.app=Tine.Tinebase.appMgr.get("Felamimail");this.i18n=this.app.i18n;this.detailsPanel=this;this.initActions();this.initToolbar();this.supr().initComponent.apply(this,arguments)},initActions:function(){this.action_deleteRecord=new Ext.Action({text:this.app.i18n._("Delete"),handler:this.onMessageDelete.createDelegate(this,[false]),iconCls:"action_delete",disabled:this.record.id.match(/_/)});this.action_reply=new Ext.Action({text:this.app.i18n._("Reply"),handler:this.onMessageReplyTo.createDelegate(this,[false]),iconCls:"action_email_reply"});this.action_replyAll=new Ext.Action({text:this.app.i18n._("Reply To All"),handler:this.onMessageReplyTo.createDelegate(this,[true]),iconCls:"action_email_replyAll"});this.action_forward=new Ext.Action({text:this.app.i18n._("Forward"),handler:this.onMessageForward.createDelegate(this),iconCls:"action_email_forward",disabled:this.record.id.match(/_/)});this.action_download=new Ext.Action({text:this.app.i18n._("Save"),handler:this.onMessageDownload.createDelegate(this),iconCls:"action_email_download",disabled:this.record.id.match(/_/)});this.action_print=new Ext.Action({text:this.app.i18n._("Print Message"),handler:this.onMessagePrint.createDelegate(this.app.getMainScreen().getCenterPanel(),[this]),iconCls:"action_print",menu:{items:[new Ext.Action({text:this.app.i18n._("Print Preview"),handler:this.onMessagePrintPreview.createDelegate(this.app.getMainScreen().getCenterPanel(),[this]),iconCls:"action_printPreview"})]}})},initToolbar:function(){this.tbar=new Ext.Toolbar({defaults:{height:55},items:[{xtype:"buttongroup",columns:5,items:[Ext.apply(new Ext.Button(this.action_reply),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_replyAll),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_forward),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.SplitButton(this.action_print),{scale:"medium",rowspan:2,iconAlign:"top",arrowAlign:"right"}),Ext.apply(new Ext.Button(this.action_download),{scale:"medium",rowspan:2,iconAlign:"top",arrowAlign:"right"})]},"->",{xtype:"buttongroup",columns:1,items:[Ext.apply(new Ext.Button(this.action_deleteRecord),{scale:"medium",rowspan:2,iconAlign:"top"})]}]})},afterRender:function(){this.supr().afterRender.apply(this,arguments);this.showMessage();var a=this.record.get("subject");if(a!==undefined){this.window.setTitle(a)}},showMessage:function(){this.layout.setActiveItem(this.getSingleRecordPanel());this.updateDetails(this.record,this.getSingleRecordPanel().body)},onAfterCompose:function(a,b,c){this.fireEvent("update",a,b,c)},onAfterDelete:function(){this.fireEvent("remove",Ext.encode(this.record.data));this.window.close()},onMessageDownload:function(){var a=new Ext.ux.file.Download({params:{method:"Felamimail.downloadMessage",requestType:"HTTP",messageId:this.record.id}}).start()},onMessageDelete:function(g){var b=Ext.ux.PopupWindowMgr.getMainWindow().Tine.Tinebase.appMgr.get("Felamimail"),a=this.record.get("folder_id"),e=b.getFolderStore().getById(a),h=e?e.get("account_id"):null,f=Tine.Felamimail.loadAccountStore().getById(h),d=f?f.getTrashFolderId():null;this.loadMask.show();if(d){var c=[{field:"id",operator:"equals",value:this.record.id}];Tine.Felamimail.messageBackend.moveMessages(c,d,{callback:this.onAfterDelete.createDelegate(this,["move"])})}else{Tine.Felamimail.messageBackend.addFlags(this.record.id,"\\Deleted",{callback:this.onAfterDelete.createDelegate(this,["flag"])})}},onMessageReplyTo:function(a){Tine.Felamimail.MessageEditDialog.openWindow({replyTo:Ext.encode(this.record.data),replyToAll:a,listeners:{update:this.onAfterCompose.createDelegate(this,["reply",Ext.encode([this.record.data])],1)}})},onMessageForward:function(){Tine.Felamimail.MessageEditDialog.openWindow({forwardMsgs:Ext.encode([this.record.data]),listeners:{update:this.onAfterCompose.createDelegate(this,["forward",Ext.encode([this.record.data])],1)}})},onMessagePrint:Tine.Felamimail.GridPanel.prototype.onPrint,onMessagePrintPreview:Tine.Felamimail.GridPanel.prototype.onPrintPreview});Tine.Felamimail.MessageDisplayDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:800,height:700,name:"TineFelamimailMessageDisplayDialog_"+c,contentPanelConstructor:"Tine.Felamimail.MessageDisplayDialog",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Felamimail");Tine.Felamimail.MessageEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{bcc:null,msgBody:"",cc:null,forwardMsgs:null,accountId:null,replyTo:null,draftOrTemplate:null,replyToAll:false,subject:"",to:null,windowNamePrefix:"MessageEditWindow_",appName:"Felamimail",recordClass:Tine.Felamimail.Model.Message,recordProxy:Tine.Felamimail.messageBackend,loadRecord:false,evalGrants:false,bodyStyle:"padding:0px",updateToolbars:Ext.emptyFn,initButtons:function(){this.fbar=[];this.action_send=new Ext.Action({text:this.app.i18n._("Send"),handler:this.onSaveAndClose,iconCls:"FelamimailIconCls",disabled:false,scope:this});this.action_searchContacts=new Ext.Action({text:this.app.i18n._("Search Recipients"),handler:this.onSearchContacts,iconCls:"AddressbookIconCls",disabled:false,scope:this});this.action_saveAsDraft=new Ext.Action({text:this.app.i18n._("Save As Draft"),handler:this.onSaveInFolder.createDelegate(this,["drafts_folder"]),iconCls:"action_saveAsDraft",disabled:false,scope:this});this.action_saveAsTemplate=new Ext.Action({text:this.app.i18n._("Save As Template"),handler:this.onSaveInFolder.createDelegate(this,["templates_folder"]),iconCls:"action_saveAsTemplate",disabled:false,scope:this});this.action_saveEmailNote=new Ext.Action({text:this.app.i18n._("Save Email Note"),handler:this.onToggleSaveNote,iconCls:"notes_noteIcon",disabled:false,scope:this,enableToggle:true});this.button_saveEmailNote=Ext.apply(new Ext.Button(this.action_saveEmailNote),{tooltip:this.app.i18n._("Activate this toggle button to save the email text as a note attached to the recipient(s) contact(s).")});this.tbar=new Ext.Toolbar({defaults:{height:55},items:[{xtype:"buttongroup",columns:5,items:[Ext.apply(new Ext.Button(this.action_send),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_searchContacts),{scale:"medium",rowspan:2,iconAlign:"top",tooltip:this.app.i18n._("Click to search for and add recipients from the Addressbook.")}),this.action_saveAsDraft,this.button_saveEmailNote,this.action_saveAsTemplate]}]})},initRecord:function(){this.decodeMsgs();if(!this.record){this.record=new this.recordClass(Tine.Felamimail.Model.Message.getDefaultData(),0)}this.initFrom();this.initRecipients();this.initSubject();this.initContent();if(this.replyTo){this.record.set("flags","\\Answered");this.record.set("original_id",this.replyTo.id)}else{if(this.forwardMsgs){this.record.set("flags","Passed");this.record.set("original_id",this.forwardMsgs[0].id)}else{if(this.draftOrTemplate){this.record.set("original_id",this.draftOrTemplate.id)}}}},initAttachements:function(a){if(a.get("attachments").length>0){this.record.set("attachments",[{name:a.get("subject"),type:"message/rfc822",size:a.get("size"),id:a.id}])}},initContent:function(){if(!this.record.get("body")){if(!this.msgBody){var a=this.getMessageFromConfig();if(a){if(!a.bodyIsFetched()){return this.recordProxy.fetchBody(a,this.initContent.createDelegate(this))}this.msgBody=a.get("body");var b=Tine.Felamimail.loadAccountStore().getById(this.record.get("account_id"));if(b.get("display_format")=="plain"||(b.get("display_format")=="content_type"&&a.get("content_type")=="text/plain")){this.msgBody=Ext.util.Format.nl2br(this.msgBody)}if(this.replyTo){this.msgBody=Ext.util.Format.htmlEncode(this.replyTo.get("from_name"))+" "+this.app.i18n._("wrote")+':<br/><blockquote class="felamimail-body-blockquote">'+this.msgBody+"</blockquote><br/>"}else{if(this.forwardMsgs&&this.forwardMsgs.length===1){this.msgBody="<br/>-----"+this.app.i18n._("Original message")+"-----<br/>"+Tine.Felamimail.GridPanel.prototype.formatHeaders(this.forwardMsgs[0].get("headers"),false,true)+"<br/><br/>"+this.msgBody+"<br/>";this.initAttachements(a)}else{if(this.draftOrTemplate){this.initAttachements(a)}}}}}if(!this.draftOrTemplate){this.msgBody+=Tine.Felamimail.getSignature(this.record.get("account_id"))}this.record.set("body",this.msgBody)}delete this.msgBody;this.onRecordLoad()},initFrom:function(){if(!this.record.get("account_id")){if(!this.accountId){var b=Ext.ux.PopupWindowMgr.getMainWindow().Tine.Tinebase.appMgr.get("Felamimail"),d=this.getMessageFromConfig(),a=d?d.get("folder_id"):null,c=a?b.getFolderStore().getById(a):null;accountId=c?c.get("account_id"):null;this.accountId=accountId||b.getActiveAccount().id}this.record.set("account_id",this.accountId)}delete this.accountId},afterRender:function(){Tine.Felamimail.MessageEditDialog.superclass.afterRender.apply(this,arguments);this.getEl().on(Ext.EventManager.useKeydown?"keydown":"keypress",this.onKeyPress,this);this.recipientGrid.on("specialkey",function(b,a){this.onKeyPress(a)},this);this.recipientGrid.on("blur",function(a){if(this.subjectField.hasFocus){return false}},this);this.htmlEditor.on("keydown",function(a){if(a.getKey()==a.ENTER&&a.ctrlKey){this.onSaveAndClose()}},this)},onKeyPress:function(b,a,c){if((b.getKey()==b.TAB||b.getKey()==b.ENTER)&&!b.shiftKey){if(b.getTarget("input[name=subject]")){this.htmlEditor.focus.defer(50,this.htmlEditor)}else{if(b.getTarget("input[type=text]")){this.subjectField.focus.defer(50,this.subjectField)}}}},getMessageFromConfig:function(){return this.replyTo?this.replyTo:this.forwardMsgs&&this.forwardMsgs.length===1?this.forwardMsgs[0]:this.draftOrTemplate?this.draftOrTemplate:null},initRecipients:function(){if(this.replyTo){var a=this.replyTo.get("headers")["reply-to"];this.to=[a?a:this.replyTo.get("from_name")+" <"+this.replyTo.get("from_email")+">"];if(this.replyToAll){this.to=this.to.concat(this.replyTo.get("to"));this.cc=this.replyTo.get("cc");var c=Tine.Felamimail.loadAccountStore().getById(this.record.get("account_id"));var b=new RegExp(c.get("email"));Ext.each(["to","cc"],function(e){for(var d=0;d<this[e].length;d++){if(b.test(this[e][d])){this[e].splice(d,1)}}},this)}}Ext.each(["to","cc","bcc"],function(d){if(this.draftOrTemplate){this[d]=this.draftOrTemplate.get(d)}if(!this.record.get(d)){this[d]=Ext.isArray(this[d])?this[d]:Ext.isString(this[d])?[this[d]]:[];this.record.set(d,Ext.unique(this[d]))}delete this[d]},this)},initSubject:function(){if(!this.record.get("subject")){if(!this.subject){if(this.replyTo){var c=this.app.i18n._("Re:"),a=new RegExp("^"+c),b=(this.replyTo.get("subject"))?this.replyTo.get("subject"):"";if(!b.match(a)){this.subject=c+" "+b}else{this.subject=b}}else{if(this.forwardMsgs){this.subject=this.app.i18n._("Fwd:")+" ";this.subject+=this.forwardMsgs.length===1?this.forwardMsgs[0].get("subject"):String.format(this.app.i18n._("{0} Message","{0} Messages",this.forwardMsgs.length))}else{if(this.draftOrTemplate){this.subject=this.draftOrTemplate.get("subject")}}}}this.record.set("subject",this.subject)}delete this.subject},decodeMsgs:function(){if(Ext.isString(this.draftOrTemplate)){this.draftOrTemplate=new this.recordClass(Ext.decode(this.draftOrTemplate))}if(Ext.isString(this.replyTo)){this.replyTo=new this.recordClass(Ext.decode(this.replyTo))}if(Ext.isString(this.forwardMsgs)){var a=[];Ext.each(Ext.decode(this.forwardMsgs),function(b){a.push(new this.recordClass(b))},this);this.forwardMsgs=a}},fixLayout:function(){if(!this.subjectField.rendered||!this.accountCombo.rendered||!this.recipientGrid.rendered){return}var a=this.recipientGrid.getView().getScrollOffset();this.subjectField.setWidth(this.subjectField.getWidth()-a+1);this.accountCombo.setWidth(this.accountCombo.getWidth()-a+1)},onSaveInFolder:function(a){this.onRecordUpdate();var b=Tine.Felamimail.loadAccountStore().getById(this.record.get("account_id"));var c=b.get(a);if(!c||c==""){Ext.MessageBox.alert(this.app.i18n._("Failed"),String.format(this.app.i18n._("{0} account setting empty."),a))}else{if(this.isValid()){this.loadMask.show();this.recordProxy.saveInFolder(this.record,c,{scope:this,success:function(d){this.fireEvent("update",Ext.util.JSON.encode(this.record.data));this.purgeListeners();this.window.close()},failure:this.onRequestFailed,timeout:150000})}else{Ext.MessageBox.alert(_("Errors"),_("Please fix the errors noted."))}}},onToggleSaveNote:function(a,b){this.record.set("note",(!this.record.get("note")))},onSearchContacts:function(){Tine.Felamimail.RecipientPickerDialog.openWindow({record:new this.recordClass(Ext.copyTo({},this.record.data,["subject","to","cc","bcc"]),Ext.id()),listeners:{scope:this,update:function(a){var b=Ext.isString(a)?new this.recordClass(Ext.decode(a)):a;this.recipientGrid.syncRecipientsToStore(["to","cc","bcc"],b,true,true)}}})},onRecordLoad:function(){if(!this.rendered){this.onRecordLoad.defer(250,this);return}var a=this.app.i18n._("Compose email:");if(this.record.get("subject")){a=a+" "+this.record.get("subject")}this.window.setTitle(a);this.getForm().loadRecord(this.record);this.attachmentGrid.loadRecord(this.record);if(this.record.get("note")&&this.record.get("note")=="1"){this.button_saveEmailNote.toggle()}this.loadMask.hide()},onRecordUpdate:function(){this.record.data.attachments=[];var a=null;this.attachmentGrid.store.each(function(b){this.record.data.attachments.push(Ext.ux.file.Uploader.file.getFileData(b))},this);Tine.Felamimail.MessageEditDialog.superclass.onRecordUpdate.call(this)},onRequestFailed:function(a,b){Ext.MessageBox.alert(this.app.i18n._("Failed"),String.format(this.app.i18n._("Could not send {0}."),this.i18nRecordName)+" ( "+this.app.i18n._("Error:")+" "+a.message+")");this.loadMask.hide()},onFromSelect:function(e,a,c){var d=Tine.Felamimail.getSignature(a.id);var b=new RegExp('<br><br><span id="felamimail-body-signature">--<br>.*</span>');var f=this.htmlEditor.getValue();f=f.replace(b,d);this.htmlEditor.setValue(f)},initAttachmentGrid:function(){if(!this.attachmentGrid){this.attachmentGrid=new Tine.widgets.grid.FileUploadGrid({fieldLabel:this.app.i18n._("Attachments"),hideLabel:true,filesProperty:"attachments",anchor:"100% 95%"});this.action_addAttachment=this.attachmentGrid.getAddAction();this.action_addAttachment.plugins[0].dropElSelector=null;this.action_addAttachment.plugins[0].onBrowseButtonClick=function(){this.southPanel.expand()}.createDelegate(this);this.tbar.get(0).insert(1,Ext.apply(new Ext.Button(this.action_addAttachment),{scale:"medium",rowspan:2,iconAlign:"top"}))}},getFormItems:function(){this.initAttachmentGrid();this.recipientGrid=new Tine.Felamimail.RecipientGrid({record:this.record,i18n:this.app.i18n,hideLabel:true});this.southPanel=new Ext.Panel({region:"south",layout:"form",height:150,split:true,collapseMode:"mini",header:false,collapsible:true,collapsed:(this.record.bodyIsFetched()&&(!this.record.get("attachments")||this.record.get("attachments").length==0)),items:[this.attachmentGrid]});this.htmlEditor=new Tine.Felamimail.ComposeEditor({fieldLabel:this.app.i18n._("Body"),flex:1});var a=Tine.Felamimail.loadAccountStore();return{border:false,frame:true,layout:"border",items:[{region:"center",layout:{align:"stretch",type:"vbox"},listeners:{afterlayout:this.fixLayout,scope:this},items:[{xtype:"combo",name:"account_id",ref:"../../accountCombo",plugins:[Ext.ux.FieldLabeler],fieldLabel:this.app.i18n._("From"),displayField:"name",valueField:"id",editable:false,triggerAction:"all",store:a,listeners:{scope:this,select:this.onFromSelect}},this.recipientGrid,{xtype:"textfield",plugins:[Ext.ux.FieldLabeler],fieldLabel:this.app.i18n._("Subject"),name:"subject",ref:"../../subjectField",enableKeyEvents:true,listeners:{scope:this,keyup:function(c,b){if(!b.isSpecialKey()){this.window.setTitle(this.app.i18n._("Compose email:")+" "+c.getValue())}}}},this.htmlEditor]},this.southPanel]}},isValid:function(){var a=(!this.attachmentGrid.isUploading());return(a&&Tine.Felamimail.MessageEditDialog.superclass.isValid.call(this))}});Tine.Felamimail.MessageEditDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:700,height:700,name:Tine.Felamimail.MessageEditDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Felamimail.MessageEditDialog",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Felamimail");Tine.Felamimail.AccountEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{windowNamePrefix:"AccountEditWindow_",appName:"Felamimail",recordClass:Tine.Felamimail.Model.Account,recordProxy:Tine.Felamimail.accountBackend,loadRecord:false,tbarItems:[],evalGrants:false,updateToolbars:function(){},onRecordLoad:function(){Tine.Felamimail.AccountEditDialog.superclass.onRecordLoad.call(this);if(this.record.get("type")=="system"){this.getForm().items.each(function(a){switch(a.name){case"signature":break;default:a.setDisabled(true)}},this)}},getFormItems:function(){this.signatureEditor=new Ext.form.HtmlEditor({fieldLabel:this.app.i18n._("Signature"),name:"signature",allowBlank:true,height:220,getDocMarkup:function(){var a='<span id="felamimail-body-signature"></span>';return a},plugins:[new Ext.ux.form.HtmlEditor.RemoveFormat()]});return{xtype:"tabpanel",deferredRender:false,border:false,activeTab:0,items:[{title:this.app.i18n._("Account"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{xtype:"textfield",anchor:"90%",labelSeparator:"",maxLength:256,columnWidth:1},items:[[{fieldLabel:this.app.i18n._("Account Name"),name:"name",allowBlank:false},{fieldLabel:this.app.i18n._("User Email"),name:"email",allowBlank:false,vtype:"email"},{fieldLabel:this.app.i18n._("User Name (From)"),name:"from"},{fieldLabel:this.app.i18n._("Organization"),name:"organization"},this.signatureEditor]]},{title:this.app.i18n._("IMAP"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{xtype:"textfield",anchor:"90%",labelSeparator:"",maxLength:256,columnWidth:1},items:[[{fieldLabel:this.app.i18n._("Host"),name:"host",allowBlank:false},{fieldLabel:this.app.i18n._("Port (Default: 143 / SSL: 993)"),name:"port",allowBlank:false,maxLength:5,xtype:"numberfield"},{fieldLabel:this.app.i18n._("Secure Connection"),name:"ssl",typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",forceSelection:true,value:"none",xtype:"combo",store:[["none",this.app.i18n._("None")],["tls",this.app.i18n._("TLS")],["ssl",this.app.i18n._("SSL")]]},{fieldLabel:this.app.i18n._("Username"),name:"user",allowBlank:false},{fieldLabel:this.app.i18n._("Password"),name:"password",emptyText:"password",inputType:"password"}]]},{title:this.app.i18n._("SMTP"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{xtype:"textfield",anchor:"90%",labelSeparator:"",maxLength:256,columnWidth:1},items:[[{fieldLabel:this.app.i18n._("Host"),name:"smtp_hostname"},{fieldLabel:this.app.i18n._("Port (Default: 25)"),name:"smtp_port",maxLength:5,xtype:"numberfield",allowBlank:false},{fieldLabel:this.app.i18n._("Secure Connection"),name:"smtp_ssl",typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",value:"none",xtype:"combo",store:[["none",this.app.i18n._("None")],["tls",this.app.i18n._("TLS")],["ssl",this.app.i18n._("SSL")]]},{fieldLabel:this.app.i18n._("Authentication"),name:"smtp_auth",typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",xtype:"combo",value:"login",store:[["none",this.app.i18n._("None")],["login",this.app.i18n._("Login")],["plain",this.app.i18n._("Plain")]]},{fieldLabel:this.app.i18n._("Username (optional)"),name:"smtp_user"},{fieldLabel:this.app.i18n._("Password (optional)"),name:"smtp_password",emptyText:"password",inputType:"password"}]]},{title:this.app.i18n._("Sieve"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{xtype:"textfield",anchor:"90%",labelSeparator:"",maxLength:256,columnWidth:1},items:[[{fieldLabel:this.app.i18n._("Host"),name:"sieve_hostname",maxLength:64},{fieldLabel:this.app.i18n._("Port (Default: 2000)"),name:"sieve_port",maxLength:5,xtype:"numberfield"},{fieldLabel:this.app.i18n._("Secure Connection"),name:"sieve_ssl",typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",value:"none",xtype:"combo",store:[["none",this.app.i18n._("None")],["tls",this.app.i18n._("TLS")]]}]]},{title:this.app.i18n._("Other Settings"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{xtype:"textfield",anchor:"90%",labelSeparator:"",maxLength:256,columnWidth:1},items:[[{fieldLabel:this.app.i18n._("Sent Folder Name"),name:"sent_folder",xtype:"felamimailfolderselect",account:this.record,maxLength:64},{fieldLabel:this.app.i18n._("Trash Folder Name"),name:"trash_folder",xtype:"felamimailfolderselect",account:this.record,maxLength:64},{fieldLabel:this.app.i18n._("Drafts Folder Name"),name:"drafts_folder",xtype:"felamimailfolderselect",account:this.record,maxLength:64},{fieldLabel:this.app.i18n._("Templates Folder Name"),name:"templates_folder",xtype:"felamimailfolderselect",account:this.record,maxLength:64},{fieldLabel:this.app.i18n._("Display Format"),name:"display_format",typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",forceSelection:true,value:"html",xtype:"combo",store:[["html",this.app.i18n._("HTML")],["plain",this.app.i18n._("Plain Text")],["content_type",this.app.i18n._("Depending on content type (experimental)")]]}]]}]}},onRequestFailed:function(a){Tine.Felamimail.handleRequestException(a);this.loadMask.hide()}});Tine.Felamimail.AccountEditDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:500,height:550,name:Tine.Felamimail.AccountEditDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Felamimail.AccountEditDialog",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Addressbook");Tine.Addressbook.SearchCombo=Ext.extend(Ext.form.ComboBox,{typeAhead:false,triggerAction:"all",pageSize:10,itemSelector:"div.search-item",store:null,minChars:3,blurOnSelect:false,userOnly:false,additionalFilters:null,selectedRecord:null,nameField:"n_fn",useAccountRecord:false,initComponent:function(){this.loadingText=_("Searching...");this.initTemplate();this.initStore();Tine.Addressbook.SearchCombo.superclass.initComponent.call(this);this.on("beforequery",this.onBeforeQuery,this)},onBeforeQuery:function(c){var b=[{field:"query",operator:"contains",value:c.query}];if(this.userOnly){b.push({field:"type",operator:"equals",value:"user"})}if(this.additionalFilters!==null&&this.additionalFilters.length>0){for(var a=0;a<this.additionalFilters.length;a++){b.push(this.additionalFilters[a])}}this.store.baseParams.filter=b},onSelect:function(a){this.selectedRecord=a;this.setValue(a.get(this.nameField));this.collapse();this.fireEvent("select",this,a);if(this.blurOnSelect){this.fireEvent("blur",this)}},onSpecialkey:function(c,b){if(b.getKey()==b.ENTER){var d=c.getValue();var a=this.store.getById(d);this.onSelect(a)}},initTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<table cellspacing="0" cellpadding="2" border="0" style="font-size: 11px;" width="100%">',"<tr>",'<td width="30%"><b>{[this.encode(values.n_fileas)]}</b><br/>{[this.encode(values.org_name)]}</td>','<td width="25%">{[this.encode(values.adr_one_street)]}<br/>',"{[this.encode(values.adr_one_postalcode)]} {[this.encode(values.adr_one_locality)]}</td>",'<td width="25%">{[this.encode(values.tel_work)]}<br/>{[this.encode(values.tel_cell)]}</td>','<td width="20%">','<img width="45px" height="39px" src="{jpegphoto}" />',"</td>","</tr>","</table>","</div></tpl>",{encode:function(a){if(a){return Ext.util.Format.htmlEncode(a)}else{return""}}})}},getValue:function(){if(this.useAccountRecord){if(this.selectedRecord){return this.selectedRecord.get("account_id")}else{return this.accountId}}else{return Tine.Addressbook.SearchCombo.superclass.getValue.call(this)}},setValue:function(a){if(this.useAccountRecord){if(a){if(a.accountId){this.accountId=a.accountId;a=a.accountDisplayName}else{if(typeof(a.get)=="function"){this.accountId=a.get("id");a=a.get("name")}}}else{this.accountId=null}}Tine.Addressbook.SearchCombo.superclass.setValue.call(this,a)},initStore:function(){if(!this.store){if(!this.contactFields){this.contactFields=Tine.Addressbook.Model.ContactArray}this.store=new Ext.data.JsonStore({fields:this.contactFields,baseParams:{method:"Addressbook.searchContacts"},root:"results",totalProperty:"totalcount",id:"id",remoteSort:true,sortInfo:{field:"n_family",direction:"ASC"}});this.store.on("beforeload",function(a,b){b.params.paging={start:b.params.start,limit:b.params.limit,sort:"n_family",dir:"ASC"}},this)}return this.store}});Ext.namespace("Tine.Felamimail");Tine.Felamimail.ContactSearchCombo=Ext.extend(Tine.Addressbook.SearchCombo,{forceSelection:false,initComponent:function(){this.additionalFilters=[{field:"email_query",operator:"contains",value:"@"}];this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">',"{[this.encode(values.n_fileas)]}"," (<b>{[this.encode(values.email, values.email_home)]}</b>)","</div></tpl>",{encode:function(a,b){if(a){return Ext.util.Format.htmlEncode(a)}else{if(b){return Ext.util.Format.htmlEncode(b)}else{return""}}}});Tine.Felamimail.ContactSearchCombo.superclass.initComponent.call(this);this.store.on("load",this.onStoreLoad,this)},onSelect:function(a){var b=Tine.Felamimail.getEmailStringFromContact(a);this.setValue(b);this.collapse();this.fireEvent("blur",this)},onStoreLoad:function(d,c,f){var e=0,b,a;Ext.each(c,function(g){if(g.get("email")&&g.get("email_home")){e++;a=Ext.copyTo({},g.data,["email_home","n_fileas"]);b=Tine.Addressbook.contactBackend.recordReader({responseText:Ext.util.JSON.encode(a)});d.insert(e,[b])}e++})}});Ext.reg("felamimailcontactcombo",Tine.Felamimail.ContactSearchCombo);Ext.namespace("Tine.Felamimail");Tine.Felamimail.RecipientGrid=Ext.extend(Ext.grid.EditorGridPanel,{cls:"felamimail-recipient-grid",record:null,contextMenu:null,store:null,autoExpandColumn:"address",clicksToEdit:1,numberOfRecordsForFixedHeight:6,header:false,border:false,deferredRender:false,forceValidation:true,enableDrop:true,ddGroup:"recipientDDGroup",initComponent:function(){this.initStore();this.initColumnModel();this.initActions();this.sm=new Ext.grid.RowSelectionModel();Tine.Felamimail.RecipientGrid.superclass.initComponent.call(this);this.on("rowcontextmenu",function(c,f,d){d.stopEvent();var b=c.getSelectionModel();if(!b.isSelected(f)){b.selectRow(f)}var a=this.store.getAt(f);this.action_remove.setDisabled(a.get("address")=="");this.contextMenu.showAt(d.getXY())},this);this.on("beforeedit",this.onBeforeEdit,this);this.on("afteredit",this.onAfterEdit,this);this.on("validateedit",this.onValidateEdit,this)},initStore:function(){this.store=new Ext.data.SimpleStore({fields:["type","address"]});this.syncRecipientsToStore(["to","cc"]);this.store.add(new Ext.data.Record({type:"to",address:""}));this.store.on("update",this.onUpdateStore,this);this.store.on("add",this.onAddStore,this)},initColumnModel:function(){var a=Tine.Tinebase.appMgr.get("Felamimail");this.searchCombo=new Tine.Felamimail.ContactSearchCombo({listeners:{scope:this,specialkey:function(d,c){var f=this.getSelectionModel(),b=f.getSelected();if((!b||b.get("address")=="")&&!f.hasNext()){this.fireEvent("specialkey",d,c)}},blur:function(c){var b=c.getValue();if(this.activeEditor&&this.activeEditor.record.get("address")!=b){this.activeEditor.record.set("address",b)}}}});this.cm=new Ext.grid.ColumnModel([{resizable:true,id:"type",dataIndex:"type",width:104,menuDisabled:true,header:"type",renderer:function(c){var b="",d=a.i18n._("Click here to set To/CC/BCC.");switch(c){case"to":b=a.i18n._("To:");break;case"cc":b=a.i18n._("Cc:");break;case"bcc":b=a.i18n._("Bcc:");break}return'<div qtip="'+d+'">'+b+"</div>"},editor:new Ext.form.ComboBox({typeAhead:false,triggerAction:"all",lazyRender:true,editable:false,mode:"local",value:null,forceSelection:true,store:[["to",a.i18n._("To:")],["cc",a.i18n._("Cc:")],["bcc",a.i18n._("Bcc:")]]})},{resizable:true,menuDisabled:true,id:"address",dataIndex:"address",header:"address",editor:this.searchCombo}])},initActions:function(){this.action_remove=new Ext.Action({text:_("Remove"),handler:this.onDelete,iconCls:"action_delete",scope:this});this.contextMenu=new Ext.menu.Menu({items:this.action_remove})},afterRender:function(){Tine.Felamimail.RecipientGrid.superclass.afterRender.call(this);if(this.store.getCount()==1){this.startEditing.defer(200,this,[0,1])}this.setFixedHeight(true);this.relayEvents(this.searchCombo,["blur"]);this.initDropTarget()},initDropTarget:function(){var a=this.getView().scroller.dom;var b=new Ext.dd.DropTarget(a,{ddGroup:"recipientDDGroup",notifyDrop:function(f,d,c){this.grid.addRecordsToStore(f.dragData.selections);return true},grid:this})},addRecordsToStore:function(b,d){if(!d){var e=this.store.getAt(this.store.findExact("address","")),d=(e)?e.get("type"):"to"}var a=false,c=false;Ext.each(b,function(f){if(f.hasEmail()){this.store.add(new Ext.data.Record({type:d,address:Tine.Felamimail.getEmailStringFromContact(f)}));c=true}},this)},setFixedHeight:function(a){if(this.store.getCount()>this.numberOfRecordsForFixedHeight){this.setHeight(155)}else{this.setHeight(this.store.getCount()*24+1)}if(a&&a===true){this.ownerCt.doLayout()}},onUpdateStore:function(c,a,b){this.syncRecipientsToRecord()},onAddStore:function(b,a,c){this.syncRecipientsToRecord()},syncRecipientsToRecord:function(){this.record.data.to=[];this.record.data.cc=[];this.record.data.bcc=[];this.store.each(function(a){if(a.data.address!=""){this.record.data[a.data.type].push(a.data.address)}},this)},syncRecipientsToStore:function(a,c,b,d){if(d){this.store.removeAll(true)}c=c||this.record;Ext.each(a,function(e){this._addRecipients(c.get(e),e)},this);this.store.sort("address");if(d){this.store.add(new Ext.data.Record({type:"to",address:""}))}if(b&&b===true){this.setFixedHeight(true)}},onAfterEdit:function(a){if(a.field=="address"){if(a.originalValue==""){this.store.add(new Ext.data.Record({type:a.record.data.type,address:""}));this.store.commitChanges();this.startEditing.defer(50,this,[a.row+1,a.column])}else{if(a.value==""){this.store.remove(a.record)}}this.setFixedHeight(false);this.ownerCt.doLayout();this.searchCombo.focus.defer(80,this.searchCombo)}},onBeforeEdit:function(a){Ext.fly(this.getView().getCell(a.row,a.column)).addClass("x-grid3-td-address-editing")},onDelete:function(b,c){var d=this.getSelectionModel();var a=d.getSelections();Ext.each(a,function(e){if(e.get("address")!=""){this.store.remove(e);this.store.fireEvent("update",this.store)}},this);this.setFixedHeight(true)},onValidateEdit:function(a){Ext.fly(this.getView().getCell(a.row,a.column)).removeClass("x-grid3-td-address-editing")},_addRecipients:function(a,c){if(a){a=Ext.unique(a);for(var b=0;b<a.length;b++){this.store.add(new Ext.data.Record({type:c,address:a[b]}))}}}});Ext.reg("felamimailrecipientgrid",Tine.Felamimail.RecipientGrid);Ext.namespace("Tine.Felamimail");Tine.Felamimail.Application=Ext.extend(Tine.Tinebase.Application,{checkMailsDelayedTask:null,defaultAccount:null,folderStore:null,updateInterval:null,updateMessageCacheTransactionId:null,getTitle:function(){return this.i18n._("Email")},init:function(){Tine.log.info("initialising app");this.checkMailsDelayedTask=new Ext.util.DelayedTask(this.checkMails,this);this.updateInterval=parseInt(Tine.Felamimail.registry.get("preferences").get("updateInterval"))*60000;Tine.log.debug('user defined update interval is "'+this.updateInterval/1000+'" seconds');this.defaultAccount=Tine.Felamimail.registry.get("preferences").get("defaultEmailAccount");Tine.log.debug('default account is "'+this.defaultAccount);if(window.isMainWindow){if(Tine.Tinebase.appMgr.getActive()!=this&&this.updateInterval){var a=this.updateInterval/20;Tine.log.debug('start preloading mails in "'+a/1000+'" seconds');this.checkMailsDelayedTask.delay(a)}this.showActiveVacation();this.checkAccounts()}},showActiveVacation:function(){var a=Tine.Felamimail.loadAccountStore().query("sieve_vacation_active",true);a.each(function(b){Ext.ux.Notification.show(this.i18n._("Active Vacation Message"),String.format(this.i18n._('Email account "{0}" has an active vacation message.'),b.get("name")))},this)},checkAccounts:function(){var b=Tine.Felamimail.loadAccountStore().query("type","system"),a=[];b.each(function(c){a.push(c.id)},this);if(a.length>0){Tine.Felamimail.accountBackend.checkAccounts(a)}},checkMails:function(d,f){this.checkMailsDelayedTask.cancel();if(!this.getFolderStore().getCount()&&this.defaultAccount){this.fetchSubfolders("/"+this.defaultAccount);return}Tine.log.info("checking mails"+(d?" for folder "+d.get("localname"):"")+" now: "+new Date());if(!d){d=this.getNextFolderToUpdate()}if(d){var e=d.isCurrentSelection()?10:Math.min(this.updateInterval/1000,120);if(this.updateMessageCacheTransactionId&&Tine.Felamimail.folderBackend.isLoading(this.updateMessageCacheTransactionId)){var a=this.folderStore.query("cache_status","pending").first(),b=Math.floor((this.updateMessageCacheTransactionExpectedResponse.getTime()-new Date().getTime())/1000);if(a&&(a!==d||b>e)){Tine.log.debug("aborting current update message request (expected response in "+b+" seconds)");Tine.Felamimail.folderBackend.abort(this.updateMessageCacheTransactionId);a.set("cache_status","incomplete");a.commit()}else{Tine.log.debug('a request updating message cache for folder "'+d.get("localname")+'" is in progress -> wait for request to return');return}}Tine.log.debug('updating message cache for folder "'+d.get("localname")+'" with '+e+" seconds max execution time");this.updateMessageCacheTransactionExpectedResponse=new Date().add(Date.SECOND,e);d.set("cache_status","pending");d.commit();this.updateMessageCacheTransactionId=Tine.Felamimail.folderBackend.updateMessageCache(d.id,e,{scope:this,callback:f,failure:this.onBackgroundRequestFail,success:function(g){Tine.Felamimail.loadAccountStore().getById(g.get("account_id")).setLastIMAPException(null);this.getFolderStore().updateFolder(g);if(g.get("cache_status")==="updating"){Tine.log.debug('updating message cache for folder "'+g.get("localname")+'" is in progress on the server (folder is locked)');return this.checkMailsDelayedTask.delay(this.updateInterval)}this.checkMailsDelayedTask.delay(0)}})}else{var c=this.fetchSubfolders();if(c){Tine.log.info('nothing more to do -> will check mails again in "'+this.updateInterval/1000+'" seconds');if(this.updateInterval>0){this.checkMailsDelayedTask.delay(this.updateInterval)}}else{this.checkMailsDelayedTask.delay(20000)}}},fetchSubfolders:function(b){var a=this.getFolderStore(),d=Tine.Felamimail.loadAccountStore(),g=true,h=false;if(!b){var f=d.findExact("all_folders_fetched",false),e=d.getAt(f);if(e){b="/"+e.id;var c=a.query("account_id",e.id);if(c.getCount()>0){var k,j=false;c.each(function(l){k=b+"/"+l.id;if(!a.isLoadedOrLoading("parent_path",k)&&(!e.get("has_children_support")||l.get("has_children"))){b=k;j=true;Tine.log.debug("fetching next level of subfolders for "+l.get("globalname"));return false}return true},this);if(!j){Tine.log.debug("all folders of account "+e.get("name")+" have been fetched ...");e.set("all_folders_fetched",true);return false}}else{Tine.log.debug("fetching first level of folders for account "+e.get("name"))}}else{Tine.log.debug("all folders of all accounts have been fetched ...");return true}}else{Tine.log.debug("no folders in store yet, fetching first level ...")}if(!a.queriesPending||a.queriesPending.length==0){a.asyncQuery("parent_path",b,this.checkMails.createDelegate(this,[]),[],this,a)}else{this.checkMailsDelayedTask.delay(0)}return false},getFolderStore:function(){if(!this.folderStore){Tine.log.debug("creating folder store");this.folderStore=new Tine.Felamimail.FolderStore({listeners:{scope:this,update:this.onUpdateFolder}})}return this.folderStore},getNextFolderToUpdate:function(){var b=this.getMainScreen().getTreePanel().getSelectionModel().getSelectedNode(),e=b?this.getFolderStore().getById(b.id):null;if(e&&e.needsUpdate(this.updateInterval)){return e}var d=this.folderStore.queryBy(function(f){return f.isInbox()&&f.needsUpdate(this.updateInterval)},this);if(d.getCount()>0){return d.first()}var a=this.folderStore.queryBy(function(f){return f.get("cache_status")!=="complete"},this);if(a.getCount()>0){return a.first()}var c=this.folderStore.queryBy(function(f){var g=f.get("client_access_time");if(!Ext.isDate(g)){return true}if(f.isInbox()&&g.getElapsed()>this.updateInterval){return true}else{if(g.getElapsed()>(this.updateInterval*5)){return true}}return false},this);if(c.getCount()>0){Tine.log.debug("still got "+c.getCount()+" outdated folders to update ...");return c.first()}return null},onBackgroundRequestFail:function(c){var a=this.folderStore.query("cache_status","pending").first();var e=a.get("account_id"),d=e?Tine.Felamimail.loadAccountStore().getById(e):null,b=d?d.get("imap_status"):null;if(d){d.setLastIMAPException(c);this.getFolderStore().each(function(f){if(f.get("account_id")===e){f.set("cache_status","disconnect");f.commit()}},this);if(c.code==912&&b!=="failure"&&Tine.Tinebase.appMgr.getActive()===this){Tine.Felamimail.folderBackend.handleRequestException(c)}}Tine.log.info("Background update failed ("+c.message+") for folder "+a.get("globalname")+' -> will check mails again in "'+this.updateInterval/1000+'" seconds');Tine.log.debug(c);this.checkMailsDelayedTask.delay(this.updateInterval)},onBeforeActivate:function(){Tine.log.info("activating felamimail now");this.checkMailsDelayedTask.delay(0)},onUpdateFolder:function(c,a,b){if(b===Ext.data.Record.EDIT&&a.isModified("cache_status")){Tine.log.info('Folder "'+a.get("localname")+'" updated with cache_status: '+a.get("cache_status"));if(["complete","pending"].indexOf(a.get("cache_status"))===-1){this.checkMailsDelayedTask.delay(1000)}if(a.isModified("cache_unreadcount")){var d=(a.get("cache_unreadcount")-a.modified.cache_unreadcount),f=Tine.Felamimail.loadAccountStore().getById(a.get("account_id"));if(d>0&&a.isInbox()){Tine.log.info("show notification: "+d+" new mails.");var g=this.i18n._("New mails"),e=String.format(this.i18n._("You got {0} new mail(s) in folder {1} ({2})."),d,a.get("localname"),f.get("name"));if(a.isCurrentSelection()){Ext.ux.Notification.show.defer(3500,this,[g,e])}else{Ext.ux.Notification.show(g,e)}}}}},getActiveAccount:function(){var b=null;var a=this.getMainScreen().getTreePanel();if(a&&a.rendered){b=a.getActiveAccount()}if(b===null){b=Tine.Felamimail.loadAccountStore().getById(Tine.Felamimail.registry.get("preferences").get("defaultEmailAccount"))}return b},showCredentialsDialog:function(a,b){Tine.Felamimail.credentialsDialog=Tine.widgets.dialog.CredentialsDialog.openWindow({windowTitle:String.format(this.i18n._("IMAP Credentials for {0}"),a.get("name")),appName:"Felamimail",credentialsId:a.id,i18nRecordName:this.i18n._("Credentials"),recordClass:Tine.Tinebase.Model.Credentials,record:new Tine.Tinebase.Model.Credentials({id:a.id,username:b?b:""}),listeners:{scope:this,update:function(f){var d=this.getFolderStore();if(d.queriesPending.length>0){var g=d.queriesPending[0].substring(16,56),e=Tine.Felamimail.loadAccountStore().getById(g),c=this.getMainScreen().getTreePanel().getNodeById(g);d.resetQueryAndRemoveRecords("parent_path","/"+g);e.set("all_folders_fetched",true);c.loading=false;c.reload(function(h){Ext.each(c.childNodes,function(j){if(Ext.util.Format.lowercase(j.attributes.localname)=="inbox"){j.select();return false}},this)})}else{this.checkMailsDelayedTask.delay(0)}}}})}});Tine.Felamimail.MainScreen=Ext.extend(Tine.widgets.MainScreen,{getTreePanel:function(){return this.getWestPanel().getContainerTreePanel()}});Tine.Felamimail.loadAccountStore=function(b){var a=Ext.StoreMgr.get("FelamimailAccountStore");if(!a){a=new Ext.data.JsonStore({fields:Tine.Felamimail.Model.Account,data:Tine.Felamimail.registry.get("accounts"),autoLoad:true,id:"id",root:"results",totalProperty:"totalcount",proxy:Tine.Felamimail.accountBackend,reader:Tine.Felamimail.accountBackend.getReader()});Ext.StoreMgr.add("FelamimailAccountStore",a)}return a};Tine.Felamimail.loadFlagsStore=function(b){var a=Ext.StoreMgr.get("FelamimailFlagsStore");if(!a){a=new Ext.data.JsonStore({fields:Tine.Felamimail.Model.Flag,data:Tine.Felamimail.registry.get("supportedFlags"),autoLoad:true,id:"id",root:"results",totalProperty:"totalcount"});Ext.StoreMgr.add("FelamimailFlagsStore",a)}return a};Tine.Felamimail.getSignature=function(e){var a="",d=Tine.Tinebase.appMgr.get("Felamimail").getMainScreen().getTreePanel().getActiveAccount();e=e||(d?d.id:"default");if(e==="default"){e=Tine.Felamimail.registry.get("preferences").get("defaultEmailAccount")}var c=Tine.Felamimail.loadAccountStore().getById(e);var b=(c)?c.get("signature"):"";if(b&&b!=""){b=Ext.util.Format.nl2br(b);a='<br><br><span id="felamimail-body-signature">--<br>'+b+"</span>"}return a};Tine.Felamimail.getEmailStringFromContact=function(b){var a=b.get("n_fileas")+" <";if(b.get("email")!=""){a+=b.get("email")}else{a+=b.get("email_home")}a+=">";return a};Tine.Felamimail.handleRequestException=function(b){Tine.log.warn("request exception :");Tine.log.warn(b);var d=Tine.Tinebase.appMgr.get("Felamimail");switch(b.code){case 910:case 911:Ext.Msg.show({title:d.i18n._("IMAP Error"),msg:b.message?b.message:d.i18n._("No connection to IMAP server."),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});break;case 912:var e=b.account&&b.account.id?b.account.id:"",c=e?Tine.Felamimail.loadAccountStore().getById(e):null,a=c?c.get("imap_status"):null;if(c){c.set("all_folders_fetched",true);d.showCredentialsDialog(c,b.username)}else{b.code=910;return this.handleRequestException(b)}break;case 913:Ext.Msg.show({title:d.i18n._("IMAP Error"),msg:d.i18n._("One of your folders was deleted from an other client, please reload you browser"),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});break;case 404:case 914:b.code=404;Tine.Tinebase.ExceptionHandler.handleRequestException(b);break;case 920:Ext.Msg.show({title:d.i18n._("SMTP Error"),msg:b.message?b.message:d.i18n._("No connection to SMTP server."),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});break;case 930:Ext.Msg.show({title:d.i18n._("Sieve Error"),msg:b.message?b.message:d.i18n._("No connection to Sieve server."),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});break;case 931:Ext.Msg.show({title:d.i18n._("Save Sieve Script Error"),msg:d.i18n._("Could not save script on Sieve server.")+(b.message?" ("+b.message+")":""),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});break;default:Tine.Tinebase.ExceptionHandler.handleRequestException(b);break}};Ext.namespace("Tine.Felamimail");Tine.Felamimail.ComposeEditor=Ext.extend(Ext.form.HtmlEditor,{cls:"felamimail-message-body-html",name:"body",allowBlank:true,getDocMarkup:function(){var a='<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title></title><style type="text/css">html,body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,fieldset,input,p,blockquote,th,td{margin:0;padding:0;}img,body,html{border:0;}address,caption,cite,code,dfn,em,strong,th,var{font-style:normal;font-weight:normal;}ol,ul {list-style:none;}caption,th {text-align:left;}h1,h2,h3,h4,h5,h6{font-size:100%;}q:before,q:after{content:\'\';}html,body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,fieldset,input,p,blockquote,th,td{font-size: small;}.felamimail-body-blockquote {margin: 5px 10px 0 3px;padding-left: 10px;border-left: 2px solid #000088;} </style></head><body style="padding: 5px 0px 0px 5px; margin: 0px"></body></html>';return a},initComponent:function(){this.plugins=[new Ext.ux.form.HtmlEditor.IndentOutdent(),new Ext.ux.form.HtmlEditor.RemoveFormat(),new Ext.ux.form.HtmlEditor.EndBlockquote()];Tine.Felamimail.ComposeEditor.superclass.initComponent.call(this)}});Ext.namespace("Ext.ux.form.HtmlEditor");Ext.ux.form.HtmlEditor.EndBlockquote=Ext.extend(Ext.util.Observable,{init:function(a){this.cmp=a;this.cmp.on("initialize",this.onInit,this)},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{keydown:this.onKeydown,scope:this})},onKeydown:function(g){if(g.getKey()==g.ENTER){var c=this.cmp.win.getSelection(),d=c.getRangeAt(0),f=this.cmp.getDoc(),h=this.getBlockquoteLevel(c);if(h>0){g.stopEvent();this.cmp.win.focus();if(h==1){this.cmp.execCmd("InsertHTML",'<br /><blockquote class="felamimail-body-blockquote"><br />');this.cmp.execCmd("outdent");this.cmp.execCmd("outdent")}else{if(h>1){for(var b=0;b<h;b++){this.cmp.execCmd("InsertHTML",'<br /><blockquote class="felamimail-body-blockquote">');this.cmp.execCmd("outdent");this.cmp.execCmd("outdent")}var a=f.createElement("br");d.insertNode(a)}}this.cmp.deferFocus()}else{if(g.ctrlKey){this.cmp.fireEvent("keydown",g)}}}},getBlockquoteLevel:function(b){var a=0,c=b.anchorNode;while(c.nodeName=="#text"||c.tagName.toLowerCase()!="body"){if(c.tagName&&c.tagName.toLowerCase()=="blockquote"){a++}c=c.parentElement}return a}});Ext.ns("Tine.Addressbook");Tine.Addressbook.ContactGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Addressbook.Model.Contact,defaultSortInfo:{field:"n_fileas",direction:"ASC"},gridConfig:{loadMask:true,autoExpandColumn:"n_fileas",enableDragDrop:true,ddGroup:"containerDDGroup"},copyEditAction:true,felamimail:false,hasDetailsPanel:true,phoneMenu:null,initComponent:function(){this.recordProxy=Tine.Addressbook.contactBackend;if(Tine.Felamimail&&Tine.Tinebase.common.hasRight("run","Felamimail")&&Tine.Felamimail.registry.get("preferences").get("useInAdb")){this.felamimail=(Tine.Felamimail.registry.get("preferences").get("useInAdb")==1)}this.gridConfig.cm=this.getColumnModel();this.filterToolbar=this.filterToolbar||this.getFilterToolbar();if(this.hasDetailsPanel){this.detailsPanel=this.getDetailsPanel()}this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);Tine.Addressbook.ContactGridPanel.superclass.initComponent.call(this)},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true,hidden:true,resizable:true},columns:this.getColumns()})},getColumns:function(){return[{id:"tid",header:this.app.i18n._("Type"),dataIndex:"tid",width:30,renderer:this.contactTidRenderer.createDelegate(this),hidden:false},{id:"tags",header:this.app.i18n._("Tags"),dataIndex:"tags",width:50,renderer:Tine.Tinebase.common.tagsRenderer,sortable:false,hidden:false},{id:"n_family",header:this.app.i18n._("Last Name"),dataIndex:"n_family"},{id:"n_given",header:this.app.i18n._("First Name"),dataIndex:"n_given",width:80},{id:"n_fn",header:this.app.i18n._("Full Name"),dataIndex:"n_fn"},{id:"n_fileas",header:this.app.i18n._("Display Name"),dataIndex:"n_fileas",hidden:false},{id:"org_name",header:this.app.i18n._("Company"),dataIndex:"org_name",width:120,hidden:false},{id:"org_unit",header:this.app.i18n._("Unit"),dataIndex:"org_unit"},{id:"title",header:this.app.i18n._("Job Title"),dataIndex:"title"},{id:"role",header:this.app.i18n._("Job Role"),dataIndex:"role"},{id:"room",header:this.app.i18n._("Room"),dataIndex:"room"},{id:"adr_one_street",header:this.app.i18n._("Street"),dataIndex:"adr_one_street"},{id:"adr_one_locality",header:this.app.i18n._("City"),dataIndex:"adr_one_locality",width:150,hidden:false},{id:"adr_one_region",header:this.app.i18n._("Region"),dataIndex:"adr_one_region"},{id:"adr_one_postalcode",header:this.app.i18n._("Postalcode"),dataIndex:"adr_one_postalcode"},{id:"adr_one_countryname",header:this.app.i18n._("Country"),dataIndex:"adr_one_countryname"},{id:"adr_two_street",header:this.app.i18n._("Street (private)"),dataIndex:"adr_two_street"},{id:"adr_two_locality",header:this.app.i18n._("City (private)"),dataIndex:"adr_two_locality"},{id:"adr_two_region",header:this.app.i18n._("Region (private)"),dataIndex:"adr_two_region"},{id:"adr_two_postalcode",header:this.app.i18n._("Postalcode (private)"),dataIndex:"adr_two_postalcode"},{id:"adr_two_countryname",header:this.app.i18n._("Country (private)"),dataIndex:"adr_two_countryname"},{id:"email",header:this.app.i18n._("Email"),dataIndex:"email",width:150,hidden:false},{id:"tel_work",header:this.app.i18n._("Phone"),dataIndex:"tel_work",hidden:false},{id:"tel_cell",header:this.app.i18n._("Mobile"),dataIndex:"tel_cell",hidden:false},{id:"tel_fax",header:this.app.i18n._("Fax"),dataIndex:"tel_fax"},{id:"tel_car",header:this.app.i18n._("Car phone"),dataIndex:"tel_car"},{id:"tel_pager",header:this.app.i18n._("Pager"),dataIndex:"tel_pager"},{id:"tel_home",header:this.app.i18n._("Phone (private)"),dataIndex:"tel_home"},{id:"tel_fax_home",header:this.app.i18n._("Fax (private)"),dataIndex:"tel_fax_home"},{id:"tel_cell_private",header:this.app.i18n._("Mobile (private)"),dataIndex:"tel_cell_private"},{id:"email_home",header:this.app.i18n._("Email (private)"),dataIndex:"email_home"},{id:"url",header:this.app.i18n._("Web"),dataIndex:"url"},{id:"url_home",header:this.app.i18n._("URL (private)"),dataIndex:"url_home"},{id:"note",header:this.app.i18n._("Note"),dataIndex:"note"},{id:"tz",header:this.app.i18n._("Timezone"),dataIndex:"tz"},{id:"geo",header:this.app.i18n._("Geo"),dataIndex:"geo"},{id:"bday",header:this.app.i18n._("Birthday"),dataIndex:"bday",renderer:Tine.Tinebase.common.dateRenderer}].concat(this.getModlogColumns().concat(this.getCustomfieldColumns()))},initActions:function(){this.actions_exportContact=new Ext.Action({requiredGrant:"exportGrant",text:this.app.i18n._("Export Contact"),iconCls:"action_export",scope:this,disabled:true,allowMultiple:true,menu:{items:[new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as PDF"),iconCls:"action_exportAsPdf",format:"pdf",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as CSV"),iconCls:"tinebase-action-export-csv",format:"csv",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ODS"),format:"ods",iconCls:"tinebase-action-export-ods",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as XLS"),format:"xls",iconCls:"tinebase-action-export-xls",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ..."),iconCls:"tinebase-action-export-xls",exportFunction:"Addressbook.exportContacts",showExportDialog:true,gridPanel:this})]}});this.phoneMenu=new Ext.menu.Menu({});this.actions_callContact=new Ext.Action({requiredGrant:"readGrant",hidden:!(Tine.Phone&&Tine.Tinebase.common.hasRight("run","Phone")),actionUpdater:this.updatePhoneActions,text:this.app.i18n._("Call contact"),disabled:true,iconCls:"PhoneIconCls",menu:this.phoneMenu,scope:this});this.actions_composeEmail=new Ext.Action({requiredGrant:"readGrant",hidden:!this.felamimail,text:this.app.i18n._("Compose email"),disabled:true,handler:this.onComposeEmail,iconCls:"action_composeEmail",scope:this,allowMultiple:true});this.actions_import=new Ext.Action({text:this.app.i18n._("Import contacts"),disabled:false,handler:this.onImport,iconCls:"action_import",scope:this,allowMultiple:true});this.actionUpdater.addActions([this.actions_exportContact,this.actions_callContact,this.actions_composeEmail,this.actions_import]);Tine.Addressbook.ContactGridPanel.superclass.initActions.call(this)},getActionToolbarItems:function(){return[Ext.apply(new Ext.SplitButton(this.actions_callContact),{scale:"medium",rowspan:2,iconAlign:"top",arrowAlign:"right"}),Ext.apply(new Ext.Button(this.actions_composeEmail),{scale:"medium",rowspan:2,iconAlign:"top"}),{xtype:"buttongroup",columns:1,frame:false,items:[this.actions_exportContact,this.actions_import]}]},getContextMenuItems:function(){var a=["-",this.actions_exportContact,"-",this.actions_callContact,this.actions_composeEmail];return a},updatePhoneActions:function(d,b,c){if(d.isHidden()){return}this.phoneMenu.removeAll();this.actions_callContact.setDisabled(true);if(c.length==1){var a=c[0];if(!a){return false}if(!Ext.isEmpty(a.data.tel_work)){this.phoneMenu.add({text:this.app.i18n._("Work")+" "+a.data.tel_work+"",scope:this,handler:this.onCallContact,field:"tel_work"});d.setDisabled(false)}if(!Ext.isEmpty(a.data.tel_home)){this.phoneMenu.add({text:this.app.i18n._("Home")+" "+a.data.tel_home+"",scope:this,handler:this.onCallContact,field:"tel_home"});d.setDisabled(false)}if(!Ext.isEmpty(a.data.tel_cell)){this.phoneMenu.add({text:this.app.i18n._("Cell")+" "+a.data.tel_cell+"",scope:this,handler:this.onCallContact,field:"tel_cell"});d.setDisabled(false)}if(!Ext.isEmpty(a.data.tel_cell_private)){this.phoneMenu.add({text:this.app.i18n._("Cell private")+" "+a.data.tel_cell_private+"",scope:this,handler:this.onCallContact,field:"tel_cell"});d.setDisabled(false)}}},onCallContact:function(b){var c;var a=this.grid.getSelectionModel().getSelected();if(!a){return}if(!Ext.isEmpty(a.get(b.field))){c=a.get(b.field)}else{if(!Ext.isEmpty(a.data.tel_work)){c=a.data.tel_work}else{if(!Ext.isEmpty(a.data.tel_cell)){c=a.data.tel_cell}else{if(!Ext.isEmpty(a.data.tel_cell_private)){c=a.data.tel_cell_private}else{if(!Ext.isEmpty(a.data.tel_home)){c=a.data.tel_work}}}}}Tine.Phone.dialPhoneNumber(c)},onComposeEmail:function(d){var e=this.grid.getSelectionModel().getSelections();var f=Tine.Felamimail.Model.Message.getDefaultData();f.body=Tine.Felamimail.getSignature();f.to=[];for(var c=0;c<e.length;c++){if(e[c].get("email")!=""){f.to.push(e[c].get("email"))}else{if(e[c].get("email_home")!=""){f.to.push(e[c].get("email_home"))}}}var a=new Tine.Felamimail.Model.Message(f,0);var b=Tine.Felamimail.MessageEditDialog.openWindow({record:a})},onImport:function(b){var a=Tine.widgets.dialog.ImportDialog.openWindow({appName:"Addressbook",listeners:{scope:this,update:function(c){this.loadGridData({preserveCursor:false,preserveSelection:false,preserveScroller:false,removeStrategy:"default"})}},record:new Tine.Tinebase.Model.ImportJob({container_id:Tine.Addressbook.registry.get("defaultAddressbook"),model:this.recordClass,import_definition_id:Tine.Addressbook.registry.get("defaultImportDefinition").id},0)})},contactTidRenderer:function(c,a,b){switch(b.get("type")){case"user":return"<img src='images/oxygen/16x16/actions/user-female.png' width='12' height='12' alt='contact' ext:qtip='"+this.app.i18n._("Internal Contact")+"'/>";default:return"<img src='images/oxygen/16x16/actions/user.png' width='12' height='12' alt='contact'/>"}},getDetailsPanel:function(){return new Tine.Addressbook.ContactGridDetailsPanel({gridpanel:this,il8n:this.app.i18n,felamimail:this.felamimail})}});Ext.ns("Tine.Felamimail");Tine.Felamimail.ContactGridPanel=Ext.extend(Tine.Addressbook.ContactGridPanel,{hasDetailsPanel:false,hasFavoritesPanel:false,disableSelectAllPages:true,hasQuickSearchFilterToolbarPlugin:false,stateId:"FelamimailContactGrid",gridConfig:{loadMask:true,autoExpandColumn:"n_fileas",enableDragDrop:false},messageRecord:null,initComponent:function(){this.addEvents("addcontacts");this.app=Tine.Tinebase.appMgr.get("Addressbook");this.filterToolbar=this.getFilterToolbar({filterFieldWidth:100,filterValueWidth:100});Tine.Felamimail.ContactGridPanel.superclass.initComponent.call(this);this.grid.on("rowdblclick",this.onRowDblClick,this);this.grid.on("cellclick",this.onCellClick,this);this.store.on("load",this.onContactStoreLoad,this)},getColumns:function(){var a=Tine.Felamimail.ContactGridPanel.superclass.getColumns.call(this);Ext.each(a,function(b){if(["n_fileas","org_name","email"].indexOf(b.dataIndex)===-1){b.hidden=true}});this.radioTpl=new Ext.XTemplate("<input",' name="'+this.id+'_{id}"',' value="{type}"',' type="radio"',' autocomplete="off"',' class="x-form-radio x-form-field"'," {checked}",">");Ext.each(["To","Cc","Bcc","None"],function(b){a.push({header:this.app.i18n._(b),dataIndex:Ext.util.Format.lowercase(b),width:50,hidden:false,renderer:this.typeRadioRenderer.createDelegate(this,[b],0)})},this);return a},typeRadioRenderer:function(f,g,b,a,h,d,c){if(!a.hasEmail()){return""}var e=Ext.util.Format.lowercase(f);return this.radioTpl.apply({id:a.id,type:e,checked:e==="none"?"checked":""})},onContactStoreLoad:function(b,a,c){Ext.each(a,function(d){Ext.each(["to","cc","bcc"],function(e){if(this.messageRecord.data[e].indexOf(Tine.Felamimail.getEmailStringFromContact(d))!==-1){this.setTypeRadio(d,e)}},this)},this)},onCellClick:function(c,g,b,f){var a=this.store.getAt(g),d=this.grid.getColumnModel().getDataIndex(b);if(!a.hasEmail()&&d!=="none"){this.setTypeRadio(a,"none")}else{this.updateRecipients(a,d)}},updateRecipients:function(a,c){var b=Tine.Felamimail.getEmailStringFromContact(a),d=false;Ext.each(["to","cc","bcc"],function(e){if(this.messageRecord.data[e].indexOf(b)!==-1){if(e!==c){this.messageRecord.data[e].remove(b)}else{d=true}}},this);if(!d&&c!=="none"){this.messageRecord.data[c].push(b)}},setTypeRadio:function(b,c){var a=[].concat(b);Ext.each(a,function(d){if(d.hasEmail()||c==="none"){Ext.select("input[name="+this.id+"_"+d.id+"]",this.grid.el).each(function(e){e.dom.checked=c===e.dom.value});this.updateRecipients(d,c)}},this)},getViewRowClass:function(a,b){var c="";if(!a.hasEmail()){c="felamimail-no-email"}return c},initActions:function(){this.actions_addAsTo=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._('Add as "To"'),disabled:true,iconCls:"action_add",actionUpdater:this.updateRecipientActions,handler:this.onAddContact.createDelegate(this,["to"]),allowMultiple:true,scope:this});this.actions_addAsCc=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._('Add as "Cc"'),disabled:true,iconCls:"action_add",actionUpdater:this.updateRecipientActions,handler:this.onAddContact.createDelegate(this,["cc"]),allowMultiple:true,scope:this});this.actions_addAsBcc=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._('Add as "Bcc"'),disabled:true,iconCls:"action_add",actionUpdater:this.updateRecipientActions,handler:this.onAddContact.createDelegate(this,["bcc"]),allowMultiple:true,scope:this});this.actions_setToNone=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._("Remove from recipients"),disabled:true,iconCls:"action_delete",actionUpdater:this.updateRecipientActions,handler:this.onAddContact.createDelegate(this,["none"]),allowMultiple:true,scope:this});this.actionUpdater.addActions([this.actions_addAsTo,this.actions_addAsCc,this.actions_addAsBcc,this.actions_setToNone])},updateRecipientActions:function(e,a,b){if(b.length>0){var d=true;for(var c=0;c<b.length;c++){if(b[c].hasEmail()){d=false;break}}e.setDisabled(d)}else{e.setDisabled(true)}},onAddContact:function(a){var b=this.grid.getSelectionModel().getSelections();this.setTypeRadio(b,a)},onRowDblClick:function(a,c,b){this.onAddContact("to")},getContextMenu:function(){if(!this.contextMenu){var a=[this.actions_addAsTo,this.actions_addAsCc,this.actions_addAsBcc,this.actions_setToNone];this.contextMenu=new Ext.menu.Menu({items:a})}return this.contextMenu}});Ext.reg("felamimailcontactgrid",Tine.Felamimail.ContactGridPanel);Ext.namespace("Tine.Felamimail");Tine.Felamimail.RecipientPickerDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{windowNamePrefix:"RecipientPickerWindow_",appName:"Felamimail",recordClass:Tine.Felamimail.Model.Message,recordProxy:Tine.Felamimail.messageBackend,loadRecord:false,evalGrants:false,mode:"local",bodyStyle:"padding:0px",updateToolbars:Ext.emptyFn,onRecordLoad:function(){if(!this.rendered){this.onRecordLoad.defer(250,this);return}var a=(this.record.get("subject")!="")?this.record.get("subject"):this.app.i18n._("(new message)");this.window.setTitle(String.format(this.app.i18n._('Select recipients for "{0}"'),a));this.loadMask.hide()},getFormItems:function(){var a=Tine.Tinebase.appMgr.get("Addressbook");this.treePanel=new Tine.widgets.container.TreePanel({region:"west",filterMode:"filterToolbar",recordClass:Tine.Addressbook.Model.Contact,app:a,width:200,minSize:100,maxSize:300,border:false,enableDrop:false});this.contactGrid=new Tine.Felamimail.ContactGridPanel({region:"center",messageRecord:this.record,app:a,plugins:[this.treePanel.getFilterPlugin()]});return{border:false,layout:"border",items:[{cls:"tine-mainscreen-centerpanel-west",region:"west",stateful:false,layout:"border",split:true,width:200,minSize:100,maxSize:300,border:false,collapsible:true,collapseMode:"mini",header:false,items:[{border:false,region:"center",items:[{xtype:"tine.widgets.mainscreen.westpanel",app:a,containerTreePanel:this.treePanel,favoritesPanel:new Tine.widgets.persistentfilter.PickerPanel({filter:[{field:"model",operator:"equals",value:"Addressbook_Model_ContactFilter"}],app:a,grid:this.contactGrid})}]}]},this.contactGrid]}}});Tine.Felamimail.RecipientPickerDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:1000,height:600,name:Tine.Felamimail.RecipientPickerDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Felamimail.RecipientPickerDialog",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Felamimail");Tine.Felamimail.FolderFilterModel=Ext.extend(Tine.widgets.grid.FilterModelMultiSelect,{operators:["in","notin"],field:"path",initComponent:function(){this.label=this.app.i18n._("Folder");this.multiselectFieldConfig={xtype:"wdgt.pickergrid",labelField:"path",layerHeight:200,selectionWidget:new Tine.Felamimail.FolderSelectTriggerField({allAccounts:true}),recordClass:Tine.Felamimail.Model.Folder,valueStore:this.app.getFolderStore(),labelRenderer:Tine.Felamimail.GridPanel.prototype.accountAndFolderRenderer.createDelegate(this),initSelectionWidget:function(){this.selectionWidget.onSelectFolder=this.addRecord.createDelegate(this)},isSelectionVisible:function(){return this.selectionWidget.selectPanel&&!this.selectionWidget.selectPanel.isDestroyed},getRecordText:function(c){var d=(Ext.isString(c))?c:(c.path)?c.path:"/"+c.id,b=this.valueStore.findExact("path",d),a=this.valueStore.getAt(b),e=null;if(!a){var f=d.substr(1,40);a=Tine.Felamimail.loadAccountStore().getById(f)}if(a){this.currentValue.push(d);this.store.add(a.copy());e=this.labelRenderer(a.id,{},a)}else{e=c;this.currentValue.push(c)}return e}};Tine.Felamimail.FolderFilterModel.superclass.initComponent.call(this)}});Tine.widgets.grid.FilterToolbar.FILTERS["tine.felamimail.folder.filtermodel"]=Tine.Felamimail.FolderFilterModel;