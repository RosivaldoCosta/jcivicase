/*
 * Tine 2.0 USER CLIENT
 * 
 * license     http://www.gnu.org/licenses/agpl.html AGPL Version 3
 * copyright   Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 *
 * FOR MORE DETAILED LICENSE AND COPYRIGHT INFORMATION PLEASE CONSULT THE LICENSE FILE 
 * LOCATED AT: <YOUR TINE 2.0 URL>/LICENSE OR VISIT THE TINE 2.0 HOMEPAGE AT http://www.tine20.org
 */
Ext.namespace("Tine.Sales","Tine.Sales.Model");Tine.Sales.Model.ProductArray=[{name:"id",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"price",type:"float"},{name:"manufacturer",type:"string"},{name:"category",type:"string"},{name:"tags"},{name:"notes"},{name:"relations"}];Tine.Sales.Model.Product=Tine.Tinebase.data.Record.create(Tine.Sales.Model.ProductArray,{appName:"Sales",modelName:"Product",idProperty:"id",titleProperty:"name",recordName:"Product",recordsName:"Products",containerProperty:"container_id",containerName:"Products",containersName:"Products",getTitle:function(){return this.get("name")?this.get("name"):false}});Tine.Sales.Model.Product.getDefaultData=function(){var a={};return a};Tine.Sales.Model.Product.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Sales");return[{label:_("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Product name"),field:"name"},{filtertype:"tinebase.tag",app:a}]};Tine.Sales.Model.ContractArray=Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"number"},{name:"title"},{name:"description"},{name:"status"},{name:"notes"},{name:"customers"},{name:"accounts"}]);Tine.Sales.Model.Contract=Tine.Tinebase.data.Record.create(Tine.Sales.Model.ContractArray,{appName:"Sales",modelName:"Contract",idProperty:"id",titleProperty:"title",recordName:"Contracts",recordsName:"Contracts",containerProperty:"container_id",containerName:"contracts list",containersName:"contracts lists"});Tine.Sales.Model.Contract.getDefaultData=function(){return{container_id:Tine.Sales.registry.get("DefaultContainer")}};Ext.namespace("Tine.Sales");Tine.Sales.MainScreen=Ext.extend(Tine.widgets.MainScreen,{activeContentType:"Product"});Tine.Sales.TreePanel=Ext.extend(Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Sales_Model_ProductFilter"}],initComponent:function(){this.filterMountId="Product";this.root={id:"root",leaf:false,expanded:true,children:[{text:this.app.i18n._("Products"),id:"Product",iconCls:"SalesProduct",expanded:true,children:[{text:this.app.i18n._("All Products"),id:"allproducts",leaf:true}]},{text:this.app.i18n._("Contracts"),id:"Contract",iconCls:"SalesContracts",expanded:true,children:[{text:this.app.i18n._("All Contracts"),id:"allcontracts",leaf:true,containerType:Tine.Tinebase.container.TYPE_SHARED,container:Tine.Sales.registry.get("DefaultContainer")}]}]};this.initContextMenu();Tine.Sales.TreePanel.superclass.initComponent.call(this);this.on("click",function(a){if(a.attributes.isPersistentFilter!=true){var b=a.getPath().split("/")[2];this.app.getMainScreen().activeContentType=b;this.app.getMainScreen().show()}},this);this.on("contextmenu",function(b,a){this.ctxNode=b;if(b.id=="allcontracts"){this.contextMenu.showAt(a.getXY())}},this)},initContextMenu:function(){this.contextMenu=Tine.widgets.tree.ContextMenu.getMenu({nodeName:this.app.i18n._("All Contracts"),actions:["grants"],scope:this,backend:"Tinebase_Container",backendModel:"Container"})},afterRender:function(){Tine.Sales.TreePanel.superclass.afterRender.call(this);var a=this.app.getMainScreen().activeContentType;this.expandPath("/root/"+a+"/allproducts");this.selectPath("/root/"+a+"/allproducts")},getFilterPlugin:function(){if(!this.filterPlugin){var a=this;this.filterPlugin=new Tine.widgets.grid.FilterPlugin({getValue:function(){return[]}})}return this.filterPlugin}});Tine.Sales.contractBackend=new Tine.Tinebase.data.RecordProxy({appName:"Sales",modelName:"Contract",recordClass:Tine.Sales.Model.Contract});Tine.Sales.productBackend=new Tine.Tinebase.data.RecordProxy({appName:"Sales",modelName:"Product",recordClass:Tine.Sales.Model.Product});Ext.namespace("Tine.Sales");Tine.Sales.ContractGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Sales.Model.Contract,defaultSortInfo:{field:"title",dir:"ASC"},gridConfig:{loadMask:true,autoExpandColumn:"title"},initComponent:function(){this.recordProxy=Tine.Sales.contractBackend;this.gridConfig.columns=this.getColumns();this.initFilterToolbar();this.plugins.push(this.filterToolbar);Tine.Sales.ContractGridPanel.superclass.initComponent.call(this)},initFilterToolbar:function(){this.filterToolbar=new Tine.widgets.grid.FilterToolbar({filterModels:[{label:_("Quick search"),field:"query",operators:["contains"]}],defaultFilter:"query",filters:[],plugins:[new Tine.widgets.grid.FilterToolbarQuickFilterPlugin()]})},getColumns:function(){return[{id:"number",header:this.app.i18n._("Contract number"),width:100,sortable:true,dataIndex:"number"},{id:"title",header:this.app.i18n._("Title"),width:200,sortable:true,dataIndex:"title"},{id:"status",header:this.app.i18n._("Status"),width:100,sortable:true,dataIndex:"status"}]}});Ext.namespace("Tine.Sales");Tine.Sales.ContractEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{labelAlign:"side",windowNamePrefix:"ContractEditWindow_",appName:"Sales",recordClass:Tine.Sales.Model.Contract,recordProxy:Tine.Sales.contractBackend,tbarItems:[{xtype:"widget-activitiesaddbutton"}],requestData:function(){this.loadRequest=Ext.Ajax.request({scope:this,success:function(a){this.record=this.recordProxy.recordReader(a);this.onRecordLoad()},params:{method:"Sales.getContract",id:this.record.id}})},getFormItems:function(){return{xtype:"tabpanel",border:false,plain:true,activeTab:0,border:false,items:[{title:this.app.i18n.n_("Contract","Contract",1),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",xtype:"columnform",labelAlign:"top",formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.333},items:[[{columnWidth:1,fieldLabel:this.app.i18n._("Title"),name:"title",allowBlank:false}],[{columnWidth:1,fieldLabel:this.app.i18n._("Description"),emptyText:this.app.i18n._("Enter description..."),name:"description",xtype:"textarea",height:200}]]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Tine.widgets.activities.ActivitiesPanel({app:"Sales",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Sales",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:this.record.id,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}}});Tine.Sales.ContractEditDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:800,height:470,name:Tine.Sales.ContractEditDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Sales.ContractEditDialog",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Sales");Tine.Sales.ProductGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Sales.Model.Product,evalGrants:false,defaultSortInfo:{field:"name",direction:"DESC"},gridConfig:{loadMask:true,autoExpandColumn:"name"},initComponent:function(){this.recordProxy=Tine.Sales.productBackend;this.actionToolbarItems=this.getToolbarItems();this.contextMenuItems=[];this.gridConfig.cm=this.getColumnModel();this.filterToolbar=this.getFilterToolbar();this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);Tine.Sales.ProductGridPanel.superclass.initComponent.call(this);this.selectionModel.on("selectionchange",function(b){var a=Tine.Tinebase.common.hasRight("manage","Sales","products");if(a){Tine.widgets.actionUpdater(b,this.actions,this.recordClass.getMeta("containerProperty"),!this.evalGrants);if(this.updateOnSelectionChange&&this.detailsPanel){this.detailsPanel.onDetailsUpdate(b)}}else{this.action_editInNewWindow.setDisabled(true);this.action_deleteRecord.setDisabled(true);this.action_tagsMassAttach.setDisabled(true)}},this);this.action_addInNewWindow.setDisabled(!Tine.Tinebase.common.hasRight("manage","Sales","products"))},getFilterToolbar:function(){return new Tine.widgets.grid.FilterToolbar({filterModels:Tine.Sales.Model.Product.getFilterModel(),defaultFilter:"query",filters:[],plugins:[new Tine.widgets.grid.FilterToolbarQuickFilterPlugin()]})},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:this.app.i18n._("Tags"),id:"tags",dataIndex:"tags",width:50,renderer:Tine.Tinebase.common.tagsRenderer,sortable:false},{header:this.app.i18n._("Name"),id:"name",dataIndex:"name",width:200},{header:this.app.i18n._("Manufacturer"),id:"manufacturer",dataIndex:"manufacturer",width:100},{header:this.app.i18n._("Category"),id:"category",dataIndex:"category",width:100},{header:this.app.i18n._("Description"),id:"description",dataIndex:"description",width:150,sortable:false,hidden:true},{header:this.app.i18n._("Price"),id:"price",dataIndex:"price",width:75,renderer:Ext.util.Format.euMoney}]})},getToolbarItems:function(){return[]}});Ext.namespace("Tine.Sales");Tine.Sales.ProductEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{windowNamePrefix:"ProductEditWindow_",appName:"Sales",recordClass:Tine.Sales.Model.Product,recordProxy:Tine.Sales.productBackend,tbarItems:[{xtype:"widget-activitiesaddbutton"}],evalGrants:false,initComponent:function(){this.linkPanel=new Tine.widgets.dialog.LinkPanel({relatedRecords:(Tine.Crm&&Tine.Tinebase.common.hasRight("run","Crm"))?{Crm_Model_Lead:{recordClass:Tine.Crm.Model.Lead,dlgOpener:Tine.Crm.LeadEditDialog.openWindow}}:{}});Tine.Sales.ProductEditDialog.superclass.initComponent.call(this)},onRecordLoad:function(){Tine.Sales.ProductEditDialog.superclass.onRecordLoad.call(this);this.linkPanel.onRecordLoad(this.record)},getFormItems:function(){return{xtype:"tabpanel",border:false,plain:true,activeTab:0,border:false,items:[{title:this.app.i18n.n_("Product","Product",1),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",xtype:"columnform",labelAlign:"top",formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.333},items:[[{columnWidth:1,fieldLabel:this.app.i18n._("Name"),name:"name",allowBlank:false}],[{columnWidth:1,xtype:"numberfield",fieldLabel:this.app.i18n._("Price"),name:"price",allowNegative:false,allowBlank:false}],[{columnWidth:1,fieldLabel:this.app.i18n._("Manufacturer"),name:"manufacturer"}],[{columnWidth:1,fieldLabel:this.app.i18n._("Category"),name:"category"}],[{columnWidth:1,fieldLabel:this.app.i18n._("Description"),emptyText:this.app.i18n._("Enter description..."),name:"description",xtype:"textarea",height:150}]]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Tine.widgets.activities.ActivitiesPanel({app:"Sales",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Sales",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:this.record.id,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")}),this.linkPanel]}}});Tine.Sales.ProductEditDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:600,height:500,name:Tine.Sales.ProductEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Sales.ProductEditDialog",contentPanelConstructorConfig:a});return b};